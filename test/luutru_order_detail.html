<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết đơn hàng - MTE192775 - Miền Tây Express</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="../css/luutruchitietdonhang.css">
    <link rel="stylesheet" href="../css/package_manager.css">
    <style>
        .data-table {
            table-layout: fixed !important;
            width: 100% !important;
            border-collapse: separate !important;
        }
        .data-table th, .data-table td {
            white-space: normal;
            word-break: break-word;
            overflow-wrap: break-word;
            padding: 0.75rem;
            display: table-cell !important;
            vertical-align: top !important;
        }
        .data-table td.text-center, .data-table th.text-center {
            text-align: center;
        }
        .data-table td.text-right, .data-table th.text-right {
            text-align: right;
        }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-bg">
                <img src="../images/logo-removebg.png" alt="Mien Tay Express Logo" class="logo">
            </div>
        </div>
        <nav class="menu-items" aria-label="Main Navigation">
             <ul>
                 <li><a href="../index.html"><i class="fa-solid fa-house icon"></i><span class="menu-text">TRANG CHỦ</span></a></li>
                 <li><a href="create-package.html"><i class="fa-solid fa-plus icon"></i><span class="menu-text">TẠO ĐƠN HÀNG</span></a></li>
                 <li>
                     <a href="#" class="submenu-parent" class="active"> <i class="fa-solid fa-chart-pie icon"></i><span class="menu-text">QUẢN LÝ</span><i class="fa-solid fa-chevron-down submenu-arrow"></i> </a>
                     <div class="submenu">
                         <ul>
                             <li><a href="package_manager.html" class="active"><i class="fa-solid fa-box-archive icon"></i><span class="menu-text">Quản lý đơn hàng</span></a></li>
                             <li><a href="straking-bill-of-lading-status.html"><i class="fa-solid fa-list-check icon"></i><span class="menu-text">Quản lý trạng thái</span></a></li>
                             <li><a href="pickup-package.html"><i class="fa-solid fa-truck-fast icon"></i><span class="menu-text">Quản lý vận chuyển</span></a></li>
                             <li><a href="#"><i class="fa-solid fa-building-user icon"></i><span class="menu-text">Quản lý chi nhánh</span></a></li>
                             <li><a href="payment-management.html"><i class="fa-solid fa-dollar-sign icon"></i><span class="menu-text">Quản lý thanh toán</span></a></li>
                         </ul>
                     </div>
                 </li>
                 <li><a href="statistics_management.html"><i class="fa-solid fa-chart-line icon"></i><span class="menu-text">THỐNG KÊ</span></a></li>
                 <li><a href="service-management.html"><i class="fa-solid fa-screwdriver-wrench icon"></i><span class="menu-text">QL DỊCH VỤ</span></a></li>
                 <li><a href="customer-list.html"><i class="fa-solid fa-users icon"></i><span class="menu-text">QL KHÁCH HÀNG</span></a></li>
                 <li><a href="employee-list.html"><i class="fa-solid fa-user-tie icon"></i><span class="menu-text">QUẢN LÝ NHÂN SỰ</span></a></li>
                 <li><a href="#"><i class="fa-solid fa-circle-info icon"></i><span class="menu-text">THÔNG TIN CÔNG TY</span></a></li>
                  <li>
                      <a href="#" class="submenu-parent"><i class="fa-solid fa-scroll icon"></i><span class="menu-text">QL CHÍNH SÁCH</span><i class="fa-solid fa-chevron-down submenu-arrow"></i></a>
                       <div class="submenu">
                          <ul>
                              <li><a href="#"><span class="menu-text">Chính sách A</span></a></li>
                              <li><a href="#"><span class="menu-text">Chính sách B</span></a></li>
                          </ul>
                      </div>
                  </li>
                 <li><a href="#"><i class="fa-solid fa-circle-question icon"></i><span class="menu-text">HƯỚNG DẪN SỬ DỤNG</span></a></li>
                 <li>
                     <a href="#" class="submenu-parent"><i class="fa-solid fa-gear icon"></i><span class="menu-text">CÀI ĐẶT CHUNG</span><i class="fa-solid fa-chevron-down submenu-arrow"></i></a>
                      <div class="submenu">
                          <ul>
                             <li><a href="#"><span class="menu-text">Cài đặt A</span></a></li>
                             <li><a href="#"><span class="menu-text">Cài đặt B</span></a></li>
                          </ul>
                      </div>
                  </li>
             </ul>
         </nav>
    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <main class="main-content">
        <header class="header">
            <button class="mobile-sidebar-toggle" id="mobile-sidebar-toggle" aria-label="Toggle Navigation Menu" aria-controls="sidebar" aria-expanded="false"> <i class="fa-solid fa-bars"></i> </button>
            <div class="header-left">
                <div class="search-container">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" class="header-search-input" placeholder="Mã vận đơn / Tracking ID...">
                </div>
            </div>
            <div class="header-actions" style="display: flex; align-items: center; gap: 1.2rem; margin-left: auto;">
                <div class="notification-wrapper">
                    <button class="notification-button" id="notification-button" title="Thông báo">
                        <i class="fa-regular fa-bell"></i>
                        <span class="notification-badge">5</span>
                    </button>
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="dropdown-header">Thông báo</div>
                        <ul class="notification-list" id="notification-list">
                            <li class="notification-item" data-title="Thông báo: DỜI CUT OFF CANADA 24/08/2024" data-body="Do lượng hàng T7 (24/08/2024) không đủ tải, chuyến tuyến MTE-CAD sẽ kết nối hàng vào chuyến bay sớm nhất (Cs sẽ update giờ cut off mới)||MTE xin lỗi Quý khách vì sự chậm trễ gây ra bất tiện cho khách hàng.||Rất mong nhận sự thông cảm của Quý khách hàng.||Cs tuyến Canada." data-timestamp="2024-07-25 13:53:27">
                                <div class="item-icon"><i class="fa-solid fa-calendar-xmark"></i></div>
                                <div class="item-content">
                                    <div class="item-title">Dời Cut off Canada 24/08/2024</div>
                                    <div class="item-time">25 Jul 2024</div>
                                </div>
                            </li>
                            <li class="notification-item" data-title="Thông báo: Cập nhật hệ thống" data-body="Hệ thống sẽ được bảo trì vào lúc 02:00 AM ngày 30/07/2024. Vui lòng lưu lại công việc trước thời gian này." data-timestamp="2024-07-28 10:00:00">
                                <div class="item-icon"><i class="fa-solid fa-wrench"></i></div>
                                <div class="item-content">
                                    <div class="item-title">Cập nhật hệ thống 30/07</div>
                                    <div class="item-time">28 Jul 2024</div>
                                </div>
                            </li>
                            <li class="notification-item" data-title="Thông báo: Khuyến mãi mới" data-body="Chương trình khuyến mãi hè 2024 đã bắt đầu! Giảm giá 10% cho các tuyến đi Mỹ." data-timestamp="2024-07-20 09:00:00">
                                <div class="item-icon"><i class="fa-solid fa-tags"></i></div>
                                <div class="item-content">
                                    <div class="item-title">Khuyến mãi hè 2024!</div>
                                    <div class="item-time">20 Jul 2024</div>
                                </div>
                            </li>
                        </ul>
                        <div class="dropdown-footer"><a href="#">Xem tất cả</a></div>
                    </div>
                </div>
                <div class="user-container" style="position: relative;">
                    <div class="user-dropdown-toggle" id="user-dropdown-toggle" style="display: flex; align-items: center; gap: 6px; background: #6366f1; border-radius: 7px; padding: 6px 14px; cursor: pointer;">
                        <i class="fa-regular fa-circle-user user-icon" id="user-icon" style="color: #fff; font-size: 1.25em;"></i>
                    </div>
                    <div class="user-dropdown" id="user-dropdown"></div>
                </div>
            </div>
        </header>

        <div class="content-wrapper">
            <section class="page-header">
                <div class="page-header-left">
                    <h1 class="page-title">Chi tiết đơn hàng - MTE192775</h1>
                    <nav class="breadcrumb" aria-label="breadcrumb"> <a href="#">Quản lý</a>/ <span>Quản lý đơn hàng</span> / <span>Chi tiết đơn hàng</span> </nav>
                </div>
            </section>

            <div class="order-detail-grid">
                <div class="detail-column-left">
                    <section class="card detail-section">
                         <div class="card-header section-header">
                            <div class="header-left">
                               <h2 class="card-title">Thông tin vận đơn (Bill Infomation)</h2>
                            </div>
                            <div class="header-actions">
                                <button class="icon-button toggle-arrow" title="Ẩn"><i class="fa-solid fa-chevron-up arrow up"></i></button>
                            </div>
                        </div>
                        <div class="card-body section-body bill-info-body">
                             <div class="data-pair">
                                <span class="label">Mã đơn hàng:</span>
                                <span class="value">MTE192775</span>
                                <button class="icon-button edit-value-icon" title="Chỉnh sửa Mã đơn"><i class="fa-solid fa-pencil"></i></button>
                            </div>
                             <div class="data-pair">
                                <span class="label">REF Code:</span>
                                <span class="value">CF341251521727VN</span>
                            </div>
                             <div class="data-pair">
                                <span class="label">Ngày tạo:</span>
                                <span class="value">19/08/2024 13:30:05</span>
                            </div>
                            <div class="data-pair">
                                <span class="label">Người tạo:</span>
                                <span class="value">PHẠM HOÀNG BÌNH</span>
                                <button class="icon-button edit-value-icon" title="Chỉnh sửa REF"><i class="fa-solid fa-pencil"></i></button>
                            </div>
                             <div class="data-pair">
                                <span class="label">Trạng thái:</span>
                                <span class="value">
                                    <span class="status-badge status-processing">Đang vận chuyển</span>
                                    <span class="status-trigger" title="Chỉnh sửa trạng thái">Xem hành trình <i class="fa-solid fa-pencil small-edit-icon"></i></span>
                                </span>
                                <button class="icon-button edit-value-icon" id="editStatusTrigger" title="Chỉnh sửa trạng thái"><i class="fa-solid fa-pencil"></i></button>
                            </div>
                             <div class="data-pair">
                                <span class="label">Dịch vụ chuyển phát:</span>
                                <span class="value" id="serviceNameValue">MTE DHL-SIN</span>
                                <button class="icon-button edit-value-icon" title="Chỉnh sửa dịch vụ" id="editServiceInfoTrigger"><i class="fa-solid fa-pencil"></i></button>
                            </div>
                             <div class="data-pair">
                                <span class="label">Dịch vụ cộng thêm:</span>
                                <span class="value" id="additionalServicesValue">Chữ ký / Bảo hiểm hàng hóa</span>
                            </div>
                            <div class="data-pair">
                                <span class="label">Ghi chú:</span>
                                <span class="value multiline">Nhận tại Bưu cục Rhode Island, Tên chính thức Tiểu bang Rhode Island, là một tiểu bang nằm trong vùng New England của Hoa Kỳ</span>
                                <button class="icon-button edit-value-icon" title="Chỉnh sửa ghi chú"><i class="fa-solid fa-pencil"></i></button>
                            </div>
                        </div>
                    </section>

                    <section class="card detail-section">
                        <div class="card-header section-header">
                            <div class="header-left"> <h2 class="card-title">Thông số kiện hàng</h2> </div>
                            <div class="header-actions"> <button class="icon-button toggle-arrow" title="Ẩn"><i class="fa-solid fa-chevron-up arrow up"></i></button> </div>
                        </div>
                        <div class="card-body section-body agent-invoice-body table-scroll">
                             <div class="data-pair">
                                 <span class="label">Nội dung hàng:</span>
                                 <span class="value" id="packageContentValue">Hàng cá nhân</span>
                                 <button class="icon-button edit-value-icon" title="Chỉnh sửa thông số kiện hàng" id="editPackageParamsTrigger"><i class="fa-solid fa-pencil"></i></button>
                             </div>
                             <div class="data-pair" style="align-items: center;">
                                 <span class="label">Khối lượng đại lý (KG):</span>
                                 <span class="value" id="agentWeightValue">
                                     23 / 13.5 / 8.5
                                     <span class="inv-mte-badge">INV-MTE</span>
                                 </span>
                                 <span class="inline-buttons">
                                     <span class="btn-inline btn-blue">B</span>
                                     <span class="btn-inline btn-teal">L</span>
                                     <span class="btn-inline btn-green">INV</span>
                                 </span>
                                 <button class="icon-button edit-value-icon" title="Chỉnh sửa thông số Kiện hàng (Reweight)" id="editAgentReweightTrigger"><i class="fa-solid fa-pencil"></i></button>
                             </div>
                             <div class="agent-invoice-dim-grid">
                                <div class="grid-header header-calc">Kích thước ban đầu (Cm)</div> <div class="grid-header header-qd">Converted Weight</div> <div class="grid-header header-dl">Re-Weight</div>
                                <div class="dim-prefix">(1/3)</div> <div class="dim-calc-value"><b>25.2</b>x<b>30.51</b>x<b>15</b>/5000= 2.3 KG</div> <div class="dim-qd-value">2.3 KG</div> <div class="dim-dl-value"></div>
                                <div class="dim-prefix">(2/3)</div> <div class="dim-calc-value"><b>12.51</b>x<b>30.51</b>x<b>42</b>/5000= 3.2 KG</div> <div class="dim-qd-value">3.2 KG</div> <div class="dim-dl-value"></div>
                                <div class="dim-prefix">(3/3)</div> <div class="dim-calc-value"><b>12</b>x<b>30.51</b>x<b>23</b>/5000= 1.68 KG</div> <div class="dim-qd-value">1.68 KG</div> <div class="dim-dl-value"></div>
                            </div>
                            <div class="agent-invoice-dim-grid">
                                <div class="grid-header header-calc">Kích thước thực tế (Cm)</div> <div class="grid-header header-qd">Converted Weight</div> <div class="grid-header header-dl">Re-Weight</div>
                                <div class="dim-prefix">(1/3)</div> <div class="dim-calc-value" id="actualDimCalc1"><b>25.2</b>x<b>30.51</b>x<b>15</b>/5000= 2.3 KG</div> <div class="dim-qd-value" id="actualConvertedWeight1">2.3 KG</div> <div class="dim-dl-value" id="reweightValue1">2.5 KG</div>
                                <div class="dim-prefix">(2/3)</div> <div class="dim-calc-value" id="actualDimCalc2"><b>12.51</b>x<b>30.51</b>x<b>42</b>/5000= 3.2 KG</div> <div class="dim-qd-value" id="actualConvertedWeight2">3.2 KG</div> <div class="dim-dl-value" id="reweightValue2">3.5 KG</div>
                                <div class="dim-prefix">(3/3)</div> <div class="dim-calc-value" id="actualDimCalc3"><b>12</b>x<b>30.51</b>x<b>23</b>/5000= 1.68 KG</div> <div class="dim-qd-value" id="actualConvertedWeight3">1.68 KG</div> <div class="dim-dl-value" id="reweightValue3">2 KG</div>
                            </div>
                             <div class="data-pair">
                                 <span class="label">Export as:</span>
                                 <span class="value">Gif (no commercial value)</span>
                                 <button class="icon-button edit-value-icon" title="Chỉnh sửa nội dung"><i class="fa-solid fa-pencil"></i></button>
                            </div>
                             <div class="export-details-line" style="display: flex; align-items: center; justify-content: space-between;">
                                 <div class="left-group" style="display: flex; align-items: center; gap: 15px;">
                                     <span class="label">Số lượng kiện:</span>
                                     <select class="form-select">
                                         <option selected>Kiện 01</option>
                                         <option>Kiện 02</option>
                                         <option>Kiện 03</option>
                                     </select>
                                     <span class="label" style="margin-left: 15px;"><strong>Giá trị hóa đơn:</strong> 50 USD</span>
                                 </div>
                                 <div class="right-group" style="margin-left: auto;">
                                     <button class="button primary small" id="editAgentItemsTrigger">
                                         <i class="fa-solid fa-box"></i> Nhập/Sửa Hàng Hóa OPS
                                     </button>
                                 </div>
                             </div>
                              <div class="table-container detail-table-container">
                                  <div class="table-wrapper">
                                      <table class="data-table">
                                          <colgroup>
                                            <col style="width:38%">
                                            <col style="width:12%">
                                            <col style="width:12%">
                                            <col style="width:14%">
                                            <col style="width:14%">
                                          </colgroup>
                                          <thead> <tr> <th>Tên sản phẩm (Đại lý)</th> <th class="col-narrow text-center">Đơn vị</th> <th class="col-narrow text-center">Số lượng</th> <th class="col-medium text-right">Đơn giá</th> <th class="col-medium text-right">Tổng giá</th> </tr> </thead>
                                          <tbody>
                                              <tr> <td> <span class="value bold">Vở note bìa trắng</span><br> <span class="value item-description">NoteBook by paper/ Vở ghi chú</span><br> <span class="value item-description">Manufacturer: Anh Nguyet Trading Service Co.,Ltd</span><br> <span class="value item-description">Address: No. 50, Lane 462 Buoi, Cong Vi Ward, Ba Dinh District, Hanoi City, Vietnam - Origin: Vietnam</span> </td> <td class="text-center value">PCE</td> <td class="text-center value">2</td> <td class="text-right value">10</td> <td class="text-right value">20</td> </tr>
                                              <tr> <td> <span class="value bold">Vở note bìa đen</span><br> <span class="value item-description">NoteBook by paper/ Vở ghi chú</span><br> <span class="value item-description">Manufacturer: Anh Nguyet Trading Service Co.,Ltd</span><br> <span class="value item-description">Address: No. 50, Lane 462 Buoi, Cong Vi Ward, Ba Dinh District, Hanoi City, Vietnam - Origin: Vietnam</span> </td> <td class="text-center value">PCE</td> <td class="text-center value">1</td> <td class="text-right value">10</td> <td class="text-right value">10</td> </tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                        </div>
                    </section>

                    <section class="card detail-section">
                         <div class="card-header section-header">
                            <div class="header-left"> <h2 class="card-title">Khai Invoice đại lý</h2> </div>
                            <div class="header-actions"> <button class="icon-button toggle-arrow" title="Ẩn"><i class="fa-solid fa-chevron-up arrow up"></i></button> </div>
                         </div>
                         <div class="card-body section-body agent-invoice-body table-scroll">
                              <div class="data-pair">
                                 <span class="label">Nội dung hàng (Đại lý):</span>
                                 <span class="value" id="agentContentValue">Hàng cá nhân</span>
                                 <button class="icon-button edit-value-icon" title="Nhập cân nặng Đại lý" id="editAgentContentTrigger"><i class="fa-solid fa-pencil"></i></button>
                              </div>
                             <div class="data-pair">
                                 <span class="label">Khối lượng đại lý (KG):</span>
                                 <span class="value">Chưa nhập </span>
                                 <span class="inv-mte-badge">INV-MTE</span>
                             </div>
                             <div class="agent-invoice-dim-grid">
                                <div class="grid-header header-calc">Kích thước ban đầu (Cm)</div> <div class="grid-header header-qd">Converted Weight</div> <div class="grid-header header-dl">Re-Weight</div>
                                <div class="dim-prefix">(1/3)</div> <div class="dim-calc-value"><b>25.2</b>x<b>30.51</b>x<b>15</b>/5000= 2.3 KG</div> <div class="dim-qd-value">2.3 KG</div> <div class="dim-dl-value"></div>
                                <div class="dim-prefix">(2/3)</div> <div class="dim-calc-value"><b>12.51</b>x<b>30.51</b>x<b>42</b>/5000= 3.2 KG</div> <div class="dim-qd-value">3.2 KG</div> <div class="dim-dl-value"></div>
                                <div class="dim-prefix">(3/3)</div> <div class="dim-calc-value"><b>12</b>x<b>30.51</b>x<b>23</b>/5000= 1.68 KG</div> <div class="dim-qd-value">1.68 KG</div> <div class="dim-dl-value"></div>
                            </div>
                            <div class="agent-invoice-dim-grid">
                                <div class="grid-header header-calc">Kích thước thực tế (Cm)</div> <div class="grid-header header-qd">Converted Weight</div> <div class="grid-header header-dl">Re-Weight</div>
                                <div class="dim-prefix">(1/3)</div> <div class="dim-calc-value" id="actualDimCalc1"><b>25.2</b>x<b>30.51</b>x<b>15</b>/5000= 2.3 KG</div> <div class="dim-qd-value" id="actualConvertedWeight1">2.3 KG</div> <div class="dim-dl-value" id="reweightValue1">2.5 KG</div>
                                <div class="dim-prefix">(2/3)</div> <div class="dim-calc-value" id="actualDimCalc2"><b>12.51</b>x<b>30.51</b>x<b>42</b>/5000= 3.2 KG</div> <div class="dim-qd-value" id="actualConvertedWeight2">3.2 KG</div> <div class="dim-dl-value" id="reweightValue2">3.5 KG</div>
                                <div class="dim-prefix">(3/3)</div> <div class="dim-calc-value" id="actualDimCalc3"><b>12</b>x<b>30.51</b>x<b>23</b>/5000= 1.68 KG</div> <div class="dim-qd-value" id="actualConvertedWeight3">1.68 KG</div> <div class="dim-dl-value" id="reweightValue3">2 KG</div>
                            </div>
                             <div class="data-pair">
                                <span class="label">Export as:</span>
                                <span class="value">Gif (no commercial value)</span>
                                <button class="icon-button edit-value-icon" title="Chỉnh sửa nội dung"><i class="fa-solid fa-pencil"></i></button>
                             </div>
                             <div class="export-details-line" style="display: flex; align-items: center; flex-wrap: wrap; gap: 15px; justify-content: space-between;">
                                 <div class="left-group" style="display: flex; align-items: center; gap: 15px;">
                                     <span class="label">Số lượng kiện:</span>
                                     <select class="form-select" id="packageCountSelectAgent">
                                         <option selected>Kiện 01</option>
                                         <option>Kiện 02</option>
                                         <option>Kiện 03</option>
                                     </select>
                                     <span class="label">
                                         <strong>Giá trị hóa đơn:</strong>
                                         <span id="invoiceValueDisplayAgent">50 USD</span>
                                     </span>
                                 </div>
                                 <div class="right-group">
                                     <button class="button primary small" id="editOpsItemsTrigger">
                                         <i class="fa-solid fa-box"></i> Nhập/Sửa Hàng Hóa Đại Lý
                                     </button>
                                 </div>
                             </div>
                              <div class="table-container detail-table-container">
                                  <div class="table-wrapper">
                                      <table class="data-table">
                                          <colgroup>
                                            <col style="width:38%">
                                            <col style="width:12%">
                                            <col style="width:12%">
                                            <col style="width:14%">
                                            <col style="width:14%">
                                          </colgroup>
                                          <thead> <tr> <th>Tên sản phẩm (Đại lý)</th> <th class="col-narrow text-center">Đơn vị</th> <th class="col-narrow text-center">Số lượng</th> <th class="col-medium text-right">Đơn giá</th> <th class="col-medium text-right">Tổng giá</th> </tr> </thead>
                                          <tbody>
                                              <tr> <td> <span class="value bold">Vở note bìa trắng</span><br> <span class="value item-description">NoteBook by paper/ Vở ghi chú</span><br> <span class="value item-description">Manufacturer: Anh Nguyet Trading Service Co.,Ltd</span><br> <span class="value item-description">Address: No. 50, Lane 462 Buoi, Cong Vi Ward, Ba Dinh District, Hanoi City, Vietnam - Origin: Vietnam</span> </td> <td class="text-center value">PCE</td> <td class="text-center value">2</td> <td class="text-right value">10</td> <td class="text-right value">20</td> </tr>
                                              <tr> <td> <span class="value bold">Vở note bìa đen</span><br> <span class="value item-description">NoteBook by paper/ Vở ghi chú</span><br> <span class="value item-description">Manufacturer: Anh Nguyet Trading Service Co.,Ltd</span><br> <span class="value item-description">Address: No. 50, Lane 462 Buoi, Cong Vi Ward, Ba Dinh District, Hanoi City, Vietnam - Origin: Vietnam</span> </td> <td class="text-center value">PCE</td> <td class="text-center value">1</td> <td class="text-right value">10</td> <td class="text-right value">10</td> </tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                         </div>
                    </section>
                </div>

                <div class="detail-column-right">
                     <section class="card detail-section">
                         <div class="card-header section-header">
                            <div class="header-left"> <h2 class="card-title">Người gửi</h2> </div>
                            <div class="header-actions"> <button class="icon-button toggle-arrow" title="Ẩn"><i class="fa-solid fa-chevron-up arrow up"></i></button> </div>
                         </div>
                         <div class="card-body section-body address-block">
                             <div class="data-pair">
                                 <span class="label">Họ và Tên:</span>
                                 <span class="value">Trần Phúc Đường</span>
                                 <button class="icon-button edit-value-icon" title="Chỉnh sửa người gửi"><i class="fa-solid fa-pencil"></i></button>
                            </div>
                             <div class="data-pair">
                                 <span class="label">Số điện thoại:</span>
                                 <span class="value">0909951549 / 0909951559</span>
                             </div>
                             <div class="data-pair">
                                 <span class="label">Địa chỉ:</span>
                                 <span class="value multiline">Tòa nhà Sài Gòn Tel, CVPM Quang Trung, P.Tân Chánh Hiệp, Q.12, TP.CHM</span>
                             </div>
                         </div>
                     </section>

                    <section class="card detail-section">
                        <div class="card-header section-header">
                            <div class="header-left"> <h2 class="card-title">Người nhận</h2> </div>
                            <div class="header-actions"> <button class="icon-button toggle-arrow" title="Ẩn"><i class="fa-solid fa-chevron-up arrow up"></i></button> </div>
                         </div>
                         <div class="card-body section-body address-block">
                              <div class="data-pair">
                                  <span class="label">Tên công ty:</span>
                                  <span class="value" id="receiverCompanyNameValue">HEPS THANH RUBBER INDUSTRIES CORPORATION</span>
                                  <button class="icon-button edit-value-icon" title="Chỉnh sửa Tên công ty"><i class="fa-solid fa-pencil"></i></button>
                              </div>
                             <div class="data-pair">
                                 <span class="label">Họ và Tên:</span>
                                 <span class="value" id="receiverNameValue">Alice the Alexander KPOP Woo Chun Pyoh Kamahamaha</span>
                                 <button class="icon-button edit-value-icon" title="Chỉnh sửa thông tin người nhận" id="editReceiverNameTrigger"><i class="fa-solid fa-pencil"></i></button>
                             </div>
                             <div class="data-pair">
                                 <span class="label">Số điện thoại:</span>
                                 <span class="value" id="receiverPhonesValue">1 (401) 426-1999 / 1 (401) 417-1995</span>
                             </div>
                             <div class="data-pair">
                                 <span class="label">Địa chỉ:</span>
                                 <span class="value multiline" id="receiverAddressValue">80 Don Avenue Rumford, Rhode Island 02916 US</span>
                             </div>
                         </div>
                     </section>

                    <section class="card detail-section">
                         <div class="card-header section-header">
                            <div class="header-left"> <h2 class="card-title">Cước phí</h2> </div>
                            <div class="header-actions"> <button class="icon-button toggle-arrow" title="Ẩn"><i class="fa-solid fa-chevron-up arrow up"></i></button> </div>
                         </div>
                        <div class="card-body section-body table-scroll">
                            <div class="table-container detail-table-container">
                                <div class="table-wrapper">
                                    <table class="summary-table charges-table">
                                        <thead>
                                            <tr>
                                                <th class="col-label">Cước phí</th>
                                                <th class="col-amount">Tiền cước</th>
                                                <th class="col-amount">Tạm tính</th>
                                                <th class="col-note"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Tổng cước</td>
                                                <td class="col-amount" id="displayBaseFare">2.318.000</td>
                                                <td class="col-amount highlight" id="displayTotalCharges">3.198.840</td>
                                                <td class="col-note">
                                                    <button class="icon-button edit-value-icon" id="adjustChargesTrigger" title="Điều chỉnh trị giá đơn hàng"><i class="fa-solid fa-pencil"></i></button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>- Chi phí khác</td>
                                                <td class="col-amount" id="displayOtherCharges">45.000</td>
                                                <td></td>
                                                <td></td>
                                            </tr>
                                            <tr>
                                                <td>- VAT</td>
                                                <td class="col-amount" id="displayVatAmount">185.440</td>
                                                <td class="col-note" id="displayVatPercent">8%</td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="charges-note">
                                 <span class="label">Ghi chú Chi phí khác:</span>
                                 <span class="value" id="displayOtherChargesNotes">Đóng kiện pallet / Phí hải quan / phụ phí đóng gói</span>
                             </div>
                        </div>
                    </section>

                   <section class="card detail-section">
                         <div class="card-header section-header">
                             <div class="header-left"> <h2 class="card-title">Lợi nhuận</h2> </div>
                             <div class="header-actions"> <button class="icon-button toggle-arrow" title="Ẩn"><i class="fa-solid fa-chevron-up arrow up"></i></button> </div>
                         </div>
                        <div class="card-body section-body table-scroll">
                            <div class="table-container detail-table-container">
                                <div class="table-wrapper">
                                    <table class="summary-table profit-table">
                                        <thead>
                                            <tr>
                                                <th class="col-label">Lợi nhuận</th>
                                                <th class="col-amount">NET Đại lý</th>
                                                <th class="col-amount">Tạm tính</th>
                                                <td class="col-note"> </td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Tổng cước đại lý:</td>
                                                <td class="col-amount">2,318,000</td>
                                                <td class="col-amount highlight">3,198,840</td>
                                                <td class="col-note">
                                                    <button class="icon-button edit-value-icon" id="editProfitTrigger" title="Điều chỉnh trị giá"><i class="fa-solid fa-pencil"></i></button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>Tổng chi phí lô hàng:</td>
                                                <td></td>
                                                <td class="col-amount">45,000</td>
                                                <td class="col-note"> </td>
                                            </tr>
                                            <tr>
                                                <td>Hoa hồng Sale:</td>
                                                 <td></td>
                                                <td class="col-amount">159,942</td>
                                                <td class="col-note"> </td>
                                            </tr>
                                             <tr>
                                                <td class="bold">Lợi nhuận công ty:</td>
                                                 <td></td>
                                                <td class="col-amount bold highlight">2,458,440</td>
                                                <td class="col-note"> </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>

             <footer class="detail-footer">
                 <div class="footer-agreement"> <input type="checkbox" id="termsAgreement" checked> <label for="termsAgreement">Tôi đã đọc và đồng ý với Điều khoản quy định</label> </div>
                 <div class="footer-actions">
                     <button class="button warning"> <i class="fa-solid fa-dollar-sign"></i> Nhập trị giá</button>
                     <button class="button primary" onclick="window.location.href='order-tracking.html'"><i class="fa-solid fa-hashtag"></i> Nhập tracking</button>
                     <button class="button confirm"> <i class="fa-solid fa-truck-pickup"></i> Tạo Pickup</button>
                     <button class="button danger"> <i class="fa-solid fa-xmark"></i> Thoát</button>
                 </div>
             </footer>

             <footer class="site-footer">
                 Miền Tây Express © <span id="current-year"></span>. All rights reserved. Design by Nina Co.,Ltd
             </footer>

        </div>
    </main>

    <div class="modal-overlay" id="editStatusModalOverlay">
        <div class="modal-content-wrapper" id="editStatusModalContent">
        </div>
    </div>
    <div id="inlineAdjustChargesContainer" style="display: none;">
    </div>

    <div class="announcement-overlay" id="announcement-overlay">
        <div class="announcement-box" id="announcement-box">
            <div class="announcement-header">
                <h3 id="announcement-title">Tiêu đề thông báo</h3>
                <button class="announcement-close-btn" id="announcement-close-btn" title="Đóng thông báo">×</button>
            </div>
            <div class="announcement-body" id="announcement-body">
                Nội dung chi tiết của thông báo sẽ được hiển thị ở đây.
            </div>
            <div class="announcement-footer">
                <span id="announcement-timestamp">Thời gian</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded - Initializing Order Detail Page (Unified)...");

            const body = document.body;
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const mobileSidebarToggleBtn = document.getElementById('mobile-sidebar-toggle');
            const desktopSidebarToggleBtn = document.querySelector('.sidebar-toggle-desktop');
            const currentDateSpan = document.getElementById('current-date');
            const currentTimeSpan = document.getElementById('current-time');
            const currentYearSpan = document.getElementById('current-year');
            const fullscreenBtn = document.getElementById('fullscreen-btn');

            const openModalTrigger = document.getElementById('editStatusTrigger');
            const modalOverlay = document.getElementById('editStatusModalOverlay');
            const modalContent = document.getElementById('editStatusModalContent');
            const openAgentItemsTrigger = document.getElementById('editAgentItemsTrigger');
            const openPackageParamsTrigger = document.getElementById('editPackageParamsTrigger');
            const packageContentDisplay = document.getElementById('packageContentValue');
            const openServiceInfoTrigger = document.getElementById('editServiceInfoTrigger');
            const serviceNameDisplay = document.getElementById('serviceNameValue');
            const additionalServicesDisplay = document.getElementById('additionalServicesValue');
            const openReceiverInfoTrigger = document.getElementById('editReceiverNameTrigger');
            const receiverNameDisplay = document.getElementById('receiverNameValue');
            const receiverPhonesDisplay = document.getElementById('receiverPhonesValue');
            const receiverAddressDisplay = document.getElementById('receiverAddressValue');
            const receiverCompanyDisplay = document.getElementById('receiverCompanyNameValue');
            const openAgentReweightTrigger = document.getElementById('editAgentReweightTrigger');
            const packageContentDisplayReweight = document.getElementById('packageContentValue');
            const reweightDisplay1 = document.getElementById('reweightValue1');
            const reweightDisplay2 = document.getElementById('reweightValue2');
            const reweightDisplay3 = document.getElementById('reweightValue3');
            const actualDimCalcDisplay1 = document.getElementById('actualDimCalc1');
            const actualDimCalcDisplay2 = document.getElementById('actualDimCalc2');
            const actualDimCalcDisplay3 = document.getElementById('actualDimCalc3');
            const actualConvertedWeightDisplay1 = document.getElementById('actualConvertedWeight1');
            const actualConvertedWeightDisplay2 = document.getElementById('actualConvertedWeight2');
            const actualConvertedWeightDisplay3 = document.getElementById('actualConvertedWeight3');
            const openOpsItemsTrigger = document.getElementById('editOpsItemsTrigger');
            const packageCountSelectOps = document.getElementById('packageCountSelectAgent');
            const invoiceValueDisplayOps = document.getElementById('invoiceValueDisplayAgent');
            const openAgentContentTrigger = document.getElementById('editAgentContentTrigger');
            const agentContentDisplay = document.getElementById('agentContentValue');
            const agentDimCalcDisplay1 = document.getElementById('agentDimCalc1');
            const agentDimCalcDisplay2 = document.getElementById('agentDimCalc2');
            const agentDimCalcDisplay3 = document.getElementById('agentDimCalc3');
            const agentConvertedWeightDisplay1 = document.getElementById('agentConvertedWeight1');
            const agentConvertedWeightDisplay2 = document.getElementById('agentConvertedWeight2');
            const agentConvertedWeightDisplay3 = document.getElementById('agentConvertedWeight3');
            const agentReweightValueDisplay1 = document.getElementById('agentReweightValue1');
            const agentReweightValueDisplay2 = document.getElementById('agentReweightValue2');
            const agentReweightValueDisplay3 = document.getElementById('agentReweightValue3');

            const adjustChargesTriggerButton = document.getElementById('adjustChargesTrigger');
            const editProfitTriggerButton = document.getElementById('editProfitTrigger');

            const notificationButton = document.getElementById('notification-button');
            const notificationDropdown = document.getElementById('notification-dropdown');
            const notificationList = document.getElementById('notification-list');
            const announcementOverlay = document.getElementById('announcement-overlay');
            const announcementBox = document.getElementById('announcement-box');
            const announcementCloseBtn = document.getElementById('announcement-close-btn');
            const announcementTitle = document.getElementById('announcement-title');
            const announcementBodyEl = document.getElementById('announcement-body');
            const announcementTimestamp = document.getElementById('announcement-timestamp');

            const manageBodyScroll = () => {
                const isSidebarOpen = body.classList.contains('sidebar-mobile-open');
                const isAnyModalVisible = document.querySelector('.modal-overlay.active') ||
                                          (announcementOverlay && announcementOverlay.classList.contains('visible'));
                if (isSidebarOpen || isAnyModalVisible) {
                    body.classList.add('overflow-hidden');
                } else {
                    body.classList.remove('overflow-hidden');
                }
            };

            function toggleSidebarMobileOrDesktop() {
                if (window.innerWidth > 768) {
                    document.body.classList.toggle('sidebar-collapsed');
                    const isCollapsed = document.body.classList.contains('sidebar-collapsed');
                    if (isCollapsed) {
                        document.querySelectorAll('.menu-items .submenu.active').forEach(submenu => {
                            submenu.classList.remove('active');
                            const parentLink = submenu.previousElementSibling;
                            if(parentLink?.classList.contains('submenu-parent')) {
                                parentLink.classList.remove('active');
                                parentLink.querySelector('.submenu-arrow')?.style.setProperty('transform', 'rotate(0deg)');
                            }
                        });
                    } else {
                        if (typeof initializeActiveSubmenu === 'function') initializeActiveSubmenu();
                    }
                } else {
                    document.body.classList.toggle('sidebar-mobile-open');
                }
                const isOpen = document.body.classList.contains('sidebar-mobile-open') || !document.body.classList.contains('sidebar-collapsed');
                const mobileSidebarToggleBtn = document.getElementById('mobile-sidebar-toggle');
                if (mobileSidebarToggleBtn) mobileSidebarToggleBtn.setAttribute('aria-expanded', String(isOpen));
                if (typeof manageBodyScroll === 'function') manageBodyScroll();
            }

            function toggleSubmenu(event) {
                event.preventDefault();
                if (body.classList.contains('sidebar-collapsed') && window.innerWidth > 768) return;
                const parentLink = event.currentTarget;
                const submenuWrapper = parentLink.nextElementSibling;
                if (!submenuWrapper || !submenuWrapper.classList.contains('submenu')) return;
                if (!parentLink.classList.contains('active')) {
                    document.querySelectorAll('.menu-items .submenu-parent.active').forEach(activeParent => {
                        if (activeParent !== parentLink) {
                            activeParent.classList.remove('active');
                            activeParent.nextElementSibling?.classList.remove('active');
                        }
                    });
                }
                submenuWrapper.classList.toggle('active');
                parentLink.classList.toggle('active');
            }

            function initializeActiveSubmenu() {
                 const activeSubmenuLink = document.querySelector('.sidebar .submenu a.active');
                 if (activeSubmenuLink) {
                      const submenuDiv = activeSubmenuLink.closest('.submenu');
                      const parentLink = submenuDiv?.previousElementSibling;
                      if(submenuDiv && parentLink && parentLink.classList.contains('submenu-parent')) {
                          submenuDiv.classList.add('active');
                          parentLink.classList.add('active');
                      }
                 }
            }

            function updateDateTime() {
                const now = new Date();
                const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
                 try {
                     let dayOfWeek; switch (now.getDay()) { case 0: dayOfWeek = "Sun"; break; case 1: dayOfWeek = "Mon"; break; case 2: dayOfWeek = "Tue"; break; case 3: dayOfWeek = "Wed"; break; case 4: dayOfWeek = "Thu"; break; case 5: dayOfWeek = "Fri"; break; case 6: dayOfWeek = "Sat"; break; default: dayOfWeek = ""; }
                     const dateString = `${dayOfWeek}, ${now.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
                     if (currentDateSpan) currentDateSpan.textContent = dateString;
                     if (currentTimeSpan) currentTimeSpan.textContent = now.toLocaleTimeString('en-US', optionsTime);
                 } catch (e) {
                     if (currentDateSpan) currentDateSpan.textContent = now.toLocaleDateString();
                     if (currentTimeSpan) currentTimeSpan.textContent = now.toLocaleTimeString();
                 }
                if (currentYearSpan) currentYearSpan.textContent = now.getFullYear();
            }

            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => console.error(`Fullscreen error: ${err.message}`));
                } else if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
            function handleFullscreenChange() {
                 const isFullscreen = !!document.fullscreenElement;
                 const icon = fullscreenBtn?.querySelector('i');
                 if(icon){
                     icon.classList.toggle('fa-expand', !isFullscreen);
                     icon.classList.toggle('fa-compress', isFullscreen);
                 }
                 if(fullscreenBtn) {
                     fullscreenBtn.setAttribute('title', isFullscreen ? 'Exit Fullscreen' : 'Fullscreen');
                 }
            }

            function toggleSection(event) {
                if (event.target.closest('button:not(.toggle-arrow), a, input, select')) {
                    return;
                }

                const header = event.currentTarget;
                const section = header.closest('.detail-section');
                const sectionBody = section?.querySelector('.section-body');
                const toggleButton = header.querySelector('.toggle-arrow');
                const arrowIcon = toggleButton?.querySelector('.arrow');

                if (sectionBody && arrowIcon && toggleButton) {
                    const isHidden = sectionBody.classList.toggle('hidden');
                    arrowIcon.classList.toggle('fa-chevron-up', !isHidden);
                    arrowIcon.classList.toggle('fa-chevron-down', isHidden);
                    toggleButton.setAttribute('title', isHidden ? 'Hiện' : 'Ẩn');
                }
            }

            function initializeSectionToggles() {
                document.querySelectorAll('.detail-section .card-header').forEach(header => {
                    const sectionBody = header.closest('.detail-section')?.querySelector('.section-body');
                    const toggleButton = header.querySelector('.toggle-arrow');
                    const arrowIcon = toggleButton?.querySelector('.arrow');

                    if (sectionBody && arrowIcon && toggleButton) {
                        const isHidden = sectionBody.classList.contains('hidden');
                        arrowIcon.classList.toggle('fa-chevron-up', !isHidden);
                        arrowIcon.classList.toggle('fa-chevron-down', isHidden);
                        toggleButton.setAttribute('title', isHidden ? 'Hiện' : 'Ẩn');

                        header.addEventListener('click', toggleSection);
                    }
                });
            }


            function closeEditModal() {
                if (modalOverlay) {
                    modalOverlay.classList.remove('active');
                    manageBodyScroll();
                }
                if (modalContent) modalContent.innerHTML = '';
                if (modalOverlay) modalOverlay.onclick = null;
                console.log("Generic modal closed.");
            }

            function executeScriptFromHtml(htmlString) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlString;
                const scriptElement = tempDiv.querySelector('script');
                if (scriptElement) {
                    try {
                        const newScript = document.createElement('script');
                        Array.from(scriptElement.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.textContent = scriptElement.textContent;
                        document.body.appendChild(newScript).parentNode.removeChild(newScript);
                        console.log("Executed script from loaded content.");
                    } catch (e) { console.error("Error executing script:", e); }
                }
            }

            function attachOverlayClickListener() {
                if (modalOverlay) {
                    modalOverlay.onclick = function(event) {
                        if (event.target === modalOverlay) closeEditModal();
                    };
                }
            }

            async function loadModalContent(formUrl, populationFunction = null, attachListenerFunction = null) {
                if (!modalContent || !modalOverlay) {
                    console.error("Modal container or overlay not found."); return;
                }
                modalContent.innerHTML = '<div style="padding:20px;color:var(--text-secondary);text-align:center;">Đang tải...</div>';
                modalOverlay.classList.add('active');
                manageBodyScroll();
                attachOverlayClickListener();

                try {
                    const response = await fetch(formUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}, URL: ${formUrl}`);
                    const htmlContent = await response.text();
                    modalContent.innerHTML = htmlContent;
                    executeScriptFromHtml(htmlContent);

                    if (typeof populationFunction === 'function') populationFunction(modalContent);
                    if (typeof attachListenerFunction === 'function') attachListenerFunction(modalContent);
                    else attachGenericModalListeners(modalContent);

                } catch (error) {
                    console.error(`Error loading modal content from ${formUrl}:`, error);
                    modalContent.innerHTML = `<div style="padding:20px;color:var(--danger-color);">Lỗi tải form: ${error.message}.</div>`;
                }
            }

             function attachGenericModalListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button');
                const confirmButton = container.querySelector('.modal-confirm-button');
                if (cancelButton) {
                    const newCancel = cancelButton.cloneNode(true);
                    cancelButton.parentNode.replaceChild(newCancel, cancelButton);
                    newCancel.addEventListener('click', closeEditModal);
                }
                 if (confirmButton) {
                    const newConfirm = confirmButton.cloneNode(true);
                    confirmButton.parentNode.replaceChild(newConfirm, confirmButton);
                    newConfirm.addEventListener('click', () => { console.log("Generic Confirm - Closing Modal"); closeEditModal(); });
                }
            }

            window.updateChargesAndProfitDisplay = function(data) {
                console.log("Updating parent page display with data:", data);
                const formatDisplay = (num) => (num === undefined || num === null || isNaN(num)) ? '0' : num.toLocaleString('vi-VN');

                const displayBaseFare = document.getElementById('displayBaseFare');
                const displayOtherCharges = document.getElementById('displayOtherCharges');
                const displayVatAmount = document.getElementById('displayVatAmount');
                const displayVatPercent = document.getElementById('displayVatPercent');
                const displayTotalCharges = document.getElementById('displayTotalCharges');
                const displayOtherChargesNotes = document.getElementById('displayOtherChargesNotes');
                const displayNetAgent = document.querySelector('.profit-table tbody tr:nth-child(1) td:nth-child(2)');
                const displayTotalAgentCharges = document.querySelector('.profit-table tbody tr:nth-child(1) td:nth-child(3)');
                const displayProfitOtherCharges = document.querySelector('.profit-table tbody tr:nth-child(2) td:nth-child(3)');
                const displaySalesCommission = document.querySelector('.profit-table tbody tr:nth-child(3) td:nth-child(3)');
                const displayCompanyProfit = document.querySelector('.profit-table tbody tr:nth-child(4) td:nth-child(3)');

                if (displayBaseFare && data.freightChargeModal !== undefined) displayBaseFare.textContent = formatDisplay(data.freightChargeModal);
                if (displayOtherCharges && data.otherCostsProfitModal !== undefined) displayOtherCharges.textContent = formatDisplay(data.otherCostsProfitModal);
                if (displayVatAmount && data.vatConvertedModal !== undefined) displayVatAmount.textContent = formatDisplay(data.vatConvertedModal);
                if (displayVatPercent && data.vatPercentProfitModal !== undefined) displayVatPercent.textContent = `${data.vatPercentProfitModal}%`;
                if (displayTotalCharges && data.totalChargesModal !== undefined) displayTotalCharges.textContent = formatDisplay(data.totalChargesModal);
                if(displayOtherChargesNotes && data.salesNoteModal !== undefined) displayOtherChargesNotes.textContent = data.salesNoteModal;

                if (displayNetAgent && data.netAgentModal !== undefined) displayNetAgent.textContent = formatDisplay(data.netAgentModal);
                if (displayTotalAgentCharges && data.totalAgentChargesModal !== undefined) displayTotalAgentCharges.textContent = formatDisplay(data.totalAgentChargesModal);
                if (displayProfitOtherCharges && data.otherCostsProfitModal !== undefined) displayProfitOtherCharges.textContent = formatDisplay(data.otherCostsProfitModal);
                if (displaySalesCommission && data.salesCommissionModal !== undefined) displaySalesCommission.textContent = formatDisplay(data.salesCommissionModal);

                const profit = (data.totalChargesModal || 0) - (data.totalAgentChargesModal || 0) - (data.salesCommissionModal || 0);
                if (displayCompanyProfit) displayCompanyProfit.textContent = formatDisplay(profit > 0 ? profit : 0);

                alert('Đã cập nhật thông tin Cước phí và Lợi nhuận.');
            }

            async function openEditModal() {
                await loadModalContent(
                    '../form_package_detail/edit-order-status.html',
                    null,
                    attachEditStatusModalListeners
                );
            }
            function attachEditStatusModalListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button');
                const confirmButton = container.querySelector('.modal-confirm-button');
                const modalForm = container.querySelector('form');
                if (cancelButton) { const newBtn = cancelButton.cloneNode(true); cancelButton.parentNode.replaceChild(newBtn, cancelButton); newBtn.addEventListener('click', closeEditModal); }
                if (confirmButton && modalForm) { const newBtn = confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newBtn, confirmButton); newBtn.addEventListener('click', () => { const formData = new FormData(modalForm); const data = Object.fromEntries(formData.entries()); console.log('Dữ liệu form modal đã xác nhận:', data); alert('Đã nhấn Xác nhận! Dữ liệu đã được log ra Console.'); closeEditModal(); });
                } else if (confirmButton) { const newBtn = confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newBtn, confirmButton); newBtn.addEventListener('click', () => { console.log('Modal confirm clicked (no form data)'); alert('Đã nhấn Xác nhận (không có form)!'); closeEditModal(); }); }
            }

            async function openAdjustProfitModal() {
                console.log("Requesting Adjust Profit Modal...");
                await loadModalContent(
                    '../form_package_detail/adjust-order-value.html',
                    populateAdjustProfitModalData,
                    attachAdjustProfitModalListeners
                );
            }
            function populateAdjustProfitModalData(container) {
                 const formElement = container.querySelector('#formAdjustProfitModal');
                 if (!formElement) { console.error("Cannot find #formAdjustProfitModal to populate."); return; }
                 console.log("Populating Adjust Profit/Charges modal form...");

                 const getNumText = (el) => el ? el.textContent.replace(/[^\d]/g, '') : '0';
                 const getPercentText = (el) => el ? el.textContent.replace(/[^\d.]/g, '') : '0';
                 const formatForInput = (numStr) => {
                     const num = parseInt(numStr);
                     return isNaN(num) ? '' : num.toLocaleString('vi-VN');
                 };

                 const displayBaseFare = document.getElementById('displayBaseFare');
                 const displayOtherCharges = document.getElementById('displayOtherCharges');
                 const displayVatPercent = document.getElementById('displayVatPercent');
                 const displayOtherChargesNotes = document.getElementById('displayOtherChargesNotes');
                 const displayNetAgent = document.querySelector('.profit-table tbody tr:nth-child(1) td:nth-child(2)');
                 const displaySalesCommission = document.querySelector('.profit-table tbody tr:nth-child(3) td:nth-child(3)');

                 if (formElement.elements.exchangeRateUSD) formElement.elements.exchangeRateUSD.value = 5;
                 if (formElement.elements.exchangeRateVND) formElement.elements.exchangeRateVND.value = formatForInput('127500');
                 if (formElement.elements.freightChargeModal && displayBaseFare) formElement.elements.freightChargeModal.value = formatForInput(getNumText(displayBaseFare));
                 if (formElement.elements.otherCostsProfitModal && displayOtherCharges) formElement.elements.otherCostsProfitModal.value = formatForInput(getNumText(displayOtherCharges));
                 if (formElement.elements.netAgentModal && displayNetAgent) formElement.elements.netAgentModal.value = formatForInput(getNumText(displayNetAgent));
                 if (formElement.elements.vatPercentProfitModal && displayVatPercent) formElement.elements.vatPercentProfitModal.value = getPercentText(displayVatPercent);
                 if (formElement.elements.salesCommissionModal && displaySalesCommission) formElement.elements.salesCommissionModal.value = formatForInput(getNumText(displaySalesCommission));
                 if (formElement.elements.salesNoteModal && displayOtherChargesNotes) formElement.elements.salesNoteModal.value = displayOtherChargesNotes.textContent.trim();

                 if (typeof window.formatCurrencyOnBlur === 'function') {
                     formElement.querySelectorAll('input[data-type="currency"], #exchangeRateVND').forEach(inp => window.formatCurrencyOnBlur(inp));
                 }
                 if (typeof window.calculateValues === 'function') {
                     console.log("Triggering initial calculation in modal form.");
                     window.calculateValues();
                 }
                 console.log("Adjust Profit modal populated.");
            }
            function attachAdjustProfitModalListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button');
                const confirmButton = container.querySelector('.modal-confirm-button');
                const formElement = container.querySelector('#formAdjustProfitModal');
                if (!formElement) { console.error("Cannot find #formAdjustProfitModal for listeners."); return; }

                if (cancelButton) { const newBtn=cancelButton.cloneNode(true); cancelButton.parentNode.replaceChild(newBtn,cancelButton); newBtn.addEventListener('click', closeEditModal); }
                if (confirmButton) {
                    const newBtn=confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newBtn,confirmButton);
                    newBtn.addEventListener('click', () => {
                        console.log("Confirming Adjust Profit/Charges modal...");
                        const formData = new FormData(formElement);
                        const profitData = {};
                        const getNum = (el) => parseInt(String(el?.value || '0').replace(/[^\d]/g, ''), 10) || 0;

                        formData.forEach((value, key) => {
                            const inputEl = formElement.elements[key];
                            if (inputEl && (inputEl.dataset.type === 'currency' || inputEl.id === 'exchangeRateVND')) profitData[key] = getNum(inputEl);
                            else if (inputEl && inputEl.type === 'number' && inputEl.step === 'any') profitData[key] = parseFloat(value) || 0;
                            else profitData[key] = value;
                        });
                         profitData['vatConvertedModal'] = getNum(formElement.elements.vatConvertedModal);
                         profitData['totalChargesModal'] = getNum(formElement.elements.totalChargesModal);
                         profitData['totalAgentChargesModal'] = getNum(formElement.elements.totalAgentChargesModal);

                        console.log('Data to update parent:', profitData);
                        if (typeof window.updateChargesAndProfitDisplay === 'function') window.updateChargesAndProfitDisplay(profitData);
                        else console.error("Update function not found!");
                        closeEditModal();
                    });
                }
            }

            async function openAgentItemsModal() { await loadModalContent('../form_package_detail/edit_package_parameters.html', null, attachAgentItemsModalListeners); }
            function attachAgentItemsModalListeners(container) {
                 const cancelButton = container.querySelector('.modal-cancel-button');
                 const confirmButton = container.querySelector('.modal-confirm-button');
                 const formElement = container.querySelector('#formPackageParamsModal');
                 if (cancelButton) { const newCancelButton = cancelButton.cloneNode(true); cancelButton.parentNode.replaceChild(newCancelButton, cancelButton); newCancelButton.addEventListener('click', closeEditModal); }
                 if (confirmButton && formElement) { const newConfirmButton = confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton); newConfirmButton.addEventListener('click', () => { console.log('Xác nhận nhập hàng hóa Đại lý!'); const items = []; const rows = formElement.querySelectorAll('.modal-item-table tbody tr'); rows.forEach(row => { const nameEl = row.querySelector('.item-name'); const qtyEl = row.querySelector('.item-qty'); const unitEl = row.querySelector('.item-unit'); const priceEl = row.querySelector('.item-price'); const totalEl = row.querySelector('.item-total'); if (nameEl && qtyEl && unitEl && priceEl && totalEl) { items.push({ name: nameEl.value, qty: qtyEl.value, unit: unitEl.value, price: priceEl.value, total: totalEl.value }); } else { console.warn("Một dòng trong bảng modal hàng hóa thiếu phần tử cần thiết, dòng này bị bỏ qua."); } }); console.log("Dữ liệu hàng hóa đã nhập:", items); alert('Đã nhấn Xác nhận Hàng hóa ĐL! Dữ liệu log ra Console.'); closeEditModal(); });
                 } else if (confirmButton) { const newConfirmButton = confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton); newConfirmButton.addEventListener('click', () => { console.log('Xác nhận nhập hàng hóa Đại lý (no form found)!'); alert('Đã nhấn Xác nhận Hàng hóa ĐL!'); closeEditModal(); }); }
            }

            async function openPackageParamsModal() { await loadModalContent('../form_package_detail/thongsokienhang.html', populatePackageParamsModalData, attachPackageParamsModalListeners); }
            function populatePackageParamsModalData(container){
                const productNameInputModal = container.querySelector('#productNameModal');
                if (productNameInputModal && packageContentDisplay) { productNameInputModal.value = packageContentDisplay.textContent.trim(); }
            }
            function attachPackageParamsModalListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button'); const confirmButton = container.querySelector('.modal-confirm-button');
                const formElement = container.querySelector('#formPackageParamsModal'); const productNameInputModal = container.querySelector('#productNameModal');
                const dimDivisorInputModal = container.querySelector('#dimDivisorModal'); const dimensionsContainerModal = container.querySelector('#dimensionsContainerModal');
                if (cancelButton) { const newCancelButton = cancelButton.cloneNode(true); cancelButton.parentNode.replaceChild(newCancelButton, cancelButton); newCancelButton.addEventListener('click', closeEditModal); }
                if (confirmButton && formElement && productNameInputModal && packageContentDisplay && dimensionsContainerModal) {
                    const newConfirmButton = confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
                    newConfirmButton.addEventListener('click', () => {
                        const newProductName = productNameInputModal.value.trim(); const newDimDivisor = dimDivisorInputModal ? dimDivisorInputModal.value : '5000'; const dimensionsData = [];
                        dimensionsContainerModal.querySelectorAll('.dimension-row').forEach(row => { const lenEl = row.querySelector('input[name="length[]"]'); const widEl = row.querySelector('input[name="width[]"]'); const heiEl = row.querySelector('input[name="height[]"]'); const weiEl = row.querySelector('input[name="weight[]"]'); if(lenEl && widEl && heiEl && weiEl) { dimensionsData.push({ length: lenEl.value, width: widEl.value, height: heiEl.value, weight: weiEl.value }); } });
                        if (newProductName) { packageContentDisplay.textContent = newProductName; console.log('Đã cập nhật thông số kiện hàng (dữ liệu lấy từ modal):', { 'Tên sản phẩm': newProductName, 'DIM': newDimDivisor, 'Kích thước/Cân nặng': dimensionsData }); alert('Đã cập nhật Tên sản phẩm. Xem Console (F12) để biết chi tiết kích thước/cân nặng.'); closeEditModal(); }
                        else { alert("Vui lòng nhập tên sản phẩm."); productNameInputModal.focus(); }
                    });
                } else if (confirmButton) { const newConfirmButton = confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton); newConfirmButton.addEventListener('click', () => { console.log('Xác nhận Thông số kiện hàng (form/elements missing)'); alert('Đã nhấn xác nhận!'); closeEditModal(); }); }
            }

            async function openServiceInfoModal() { await loadModalContent('../form_package_detail/edit-service-information.html', populateServiceInfoModalData, attachServiceInfoModalListeners); }
            function populateServiceInfoModalData(container){
                const currentServiceText = serviceNameDisplay ? serviceNameDisplay.textContent.trim() : '';
                const serviceSelectModal = container.querySelector('#serviceSelectModal');
                if (serviceSelectModal && currentServiceText) { const currentOption = Array.from(serviceSelectModal.options).find(opt => opt.text === currentServiceText); if (currentOption) { currentOption.selected = true; } }
                const currentAddServices = additionalServicesDisplay ? additionalServicesDisplay.textContent.split(' / ').map(s => s.trim()) : [];
                const addServiceCheckboxes = container.querySelectorAll('input[name^="add_service_"]');
                addServiceCheckboxes.forEach(checkbox => { const serviceName = checkbox.name.replace('add_service_', ''); let displayName = ''; if (serviceName === 'signature') displayName = 'Chữ ký'; else if (serviceName === 'insurance') displayName = 'Bảo hiểm hàng hóa'; else if (serviceName === 'fumigation') displayName = 'FUMIGATION'; else if (serviceName === 'wood_crate') displayName = 'Đóng kiện gỗ'; else displayName = serviceName.toUpperCase(); if (currentAddServices.includes(displayName)) { checkbox.checked = true; } });
            }
            function attachServiceInfoModalListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button'); const confirmButton = container.querySelector('.modal-confirm-button');
                const formElement = container.querySelector('#formServiceInfoModal');
                if (!formElement) return;
                if (cancelButton) { const newCancelButton = cancelButton.cloneNode(true); cancelButton.parentNode.replaceChild(newCancelButton, cancelButton); newCancelButton.addEventListener('click', closeEditModal); }
                if (confirmButton) {
                    const newConfirmButton = confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
                    newConfirmButton.addEventListener('click', () => {
                        const formData = new FormData(formElement); const serviceData = {}; const additionalServices = []; let selectedServiceText = '';
                        for (const [key, value] of formData.entries()) { if (key === 'service_code') { serviceData[key] = value; const selectedOption = formElement.querySelector(`#serviceSelectModal option[value="${value}"]`); selectedServiceText = selectedOption ? selectedOption.text : value; } else if (key.startsWith('add_service_')) { additionalServices.push(key.replace('add_service_', '')); } else { serviceData[key] = value; } }
                        serviceData.additional_services = additionalServices;
                        console.log('Đã xác nhận thông tin dịch vụ (dữ liệu lấy từ modal):', serviceData);
                        if (serviceNameDisplay && selectedServiceText) { serviceNameDisplay.textContent = selectedServiceText; }
                        if (additionalServicesDisplay) { const displayNames = serviceData.additional_services.map(s => { if (s === 'signature') return 'Chữ ký'; if (s === 'insurance') return 'Bảo hiểm hàng hóa'; if (s === 'fumigation') return 'FUMIGATION'; if (s === 'wood_crate') return 'Đóng kiện gỗ'; return s.toUpperCase(); }); additionalServicesDisplay.textContent = displayNames.join(' / '); }
                        alert('Đã cập nhật thông tin Dịch vụ. Xem Console (F12) để biết chi tiết.'); closeEditModal();
                    });
                }
            }

            async function openReceiverInfoModal() { await loadModalContent('../form_package_detail/edit-receiver-info.html', populateReceiverInfoModalData, attachReceiverInfoModalListeners); }
            function populateReceiverInfoModalData(container){
                const nameInput = container.querySelector('#receiverNameInputModal'); const companyInput = container.querySelector('#receiverCompanyInputModal'); const phone1NumInput = container.querySelector('#receiverPhone1NumberModal'); const phone2NumInput = container.querySelector('#receiverPhone2NumberModal'); const countrySelect = container.querySelector('#receiverCountryModal'); const postcodeInput = container.querySelector('#receiverPostcodeModal'); const cityInput = container.querySelector('#receiverCityModal'); const stateInput = container.querySelector('#receiverStateModal'); const addressInput = container.querySelector('#receiverAddressModal');
                if (nameInput && receiverNameDisplay) nameInput.value = receiverNameDisplay.textContent.trim(); if (companyInput && receiverCompanyDisplay) companyInput.value = receiverCompanyDisplay.textContent.trim();
                if (receiverPhonesDisplay) { const phones = receiverPhonesDisplay.textContent.split('/'); if (phones.length > 0 && phone1NumInput) phone1NumInput.value = phones[0].replace(/[^0-9]/g, ''); if (phones.length > 1 && phone2NumInput) phone2NumInput.value = phones[1].replace(/[^0-9]/g, ''); }
                if (receiverAddressDisplay) { const fullAddress = receiverAddressDisplay.textContent.trim(); const addressParts = fullAddress.split(/,\s*|\s+/); if (addressInput) addressInput.value = fullAddress; if (addressParts.length > 0 && countrySelect) { const countryCode = addressParts[addressParts.length -1].toUpperCase(); if (Array.from(countrySelect.options).some(opt => opt.value === countryCode)) countrySelect.value = countryCode; } if (addressParts.length > 1 && postcodeInput) { const potentialZip = addressParts[addressParts.length - 2]; if (/^\d{5}(-\d{4})?$/.test(potentialZip) || /^[A-Z]\d[A-Z] \d[A-Z]\d$/i.test(potentialZip)) postcodeInput.value = potentialZip; } }
                if (countrySelect && !countrySelect.value) countrySelect.value = "US";
            }
            function attachReceiverInfoModalListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button'); const confirmButton = container.querySelector('.modal-confirm-button');
                const formElement = container.querySelector('#formReceiverInfoModal');
                if (!formElement) return;
                if (cancelButton) { const newCancelButton = cancelButton.cloneNode(true); cancelButton.parentNode.replaceChild(newCancelButton, cancelButton); newCancelButton.addEventListener('click', closeEditModal); }
                if (confirmButton) {
                    const newConfirmButton = confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
                    newConfirmButton.addEventListener('click', () => {
                        const formData = new FormData(formElement); const receiverData = Object.fromEntries(formData.entries()); console.log('Đã xác nhận thông tin người nhận (dữ liệu lấy từ modal):', receiverData);
                        if (receiverNameDisplay && receiverData.receiver_name) receiverNameDisplay.textContent = receiverData.receiver_name; if (receiverCompanyDisplay && receiverData.receiver_company) receiverCompanyDisplay.textContent = receiverData.receiver_company;
                        if (receiverPhonesDisplay) { let phoneStr = `${receiverData.phone1_number || ''}`; if (receiverData.phone2_number) phoneStr += ` / ${receiverData.phone2_number}`; receiverPhonesDisplay.textContent = phoneStr.trim().replace(/^\/|\/$/g, '').trim(); }
                        if (receiverAddressDisplay && receiverData.address_line1) receiverAddressDisplay.textContent = receiverData.address_line1;
                        alert('Đã cập nhật thông tin Người nhận. Xem Console (F12) để biết chi tiết.'); closeEditModal();
                    });
                }
            }

            async function openAgentReweightModal() { await loadModalContent('../form_package_detail/edit-package-reweight.html', populateAgentReweightModalData, attachAgentReweightListeners); }
            function populateAgentReweightModalData(container){
                const productNameInputModal = container.querySelector('#productNameModal'); const dimDivisorInputModal = container.querySelector('#dimDivisorModal'); const dimensionsContainerModal = container.querySelector('#dimensionsContainerModal');
                if (productNameInputModal && packageContentDisplayReweight) productNameInputModal.value = packageContentDisplayReweight.textContent.trim();
                if (dimDivisorInputModal) { const calcText = actualDimCalcDisplay1 ? actualDimCalcDisplay1.textContent : ''; const dimMatch = calcText.match(/\/(\d+)/); dimDivisorInputModal.value = dimMatch ? dimMatch[1] : "5000"; }
                if (dimensionsContainerModal) { let modalRows = dimensionsContainerModal.querySelectorAll('.dimension-row'); const actualDimCalcElements = [actualDimCalcDisplay1, actualDimCalcDisplay2, actualDimCalcDisplay3]; const reweightValueElements = [reweightDisplay1, reweightDisplay2, reweightDisplay3]; const dataRowCount = actualDimCalcElements.filter(el => el && el.textContent.trim() !== '').length; while(modalRows.length > dataRowCount && modalRows.length > 1) { modalRows[modalRows.length - 1].remove(); modalRows = dimensionsContainerModal.querySelectorAll('.dimension-row'); } while(modalRows.length < dataRowCount) { const addButton = container.querySelector('#btnAddDimRowModal'); if (addButton) addButton.click(); else break; modalRows = dimensionsContainerModal.querySelectorAll('.dimension-row'); } modalRows.forEach((row, index) => { const calcEl = actualDimCalcElements[index]; const weightEl = reweightValueElements[index]; const lengthInput = row.querySelector('input[name="length[]"]'); const widthInput = row.querySelector('input[name="width[]"]'); const heightInput = row.querySelector('input[name="height[]"]'); const weightInput = row.querySelector('input[name="weight[]"]'); if (calcEl) { const dimMatch = calcEl.textContent.match(/<b>(\d+(\.\d+)?)<\/b>\s*x\s*<b>(\d+(\.\d+)?)<\/b>\s*x\s*<b>(\d+(\.\d+)?)<\/b>/); if (dimMatch && lengthInput && widthInput && heightInput) { lengthInput.value = dimMatch[1] || ''; widthInput.value = dimMatch[3] || ''; heightInput.value = dimMatch[5] || ''; } } if (weightEl && weightInput) { const weightMatch = weightEl.textContent.match(/(\d+(\.\d+)?)/); weightInput.value = weightMatch ? weightMatch[1] : ''; } }); }
            }
            function attachAgentReweightListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button'); const confirmButton = container.querySelector('.modal-confirm-button');
                const formElement = container.querySelector('#formPackageParamsModal');
                if (!formElement) return;
                if (cancelButton) { const newCancelButton = cancelButton.cloneNode(true); cancelButton.parentNode.replaceChild(newCancelButton, cancelButton); newCancelButton.addEventListener('click', closeEditModal); }
                if (confirmButton) {
                    const newConfirmButton = confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
                    newConfirmButton.addEventListener('click', () => {
                        const formData = new FormData(formElement); const reweightData = { dimensions: [] }; reweightData.product_name = formData.get('product_name'); reweightData.dim_divisor = formData.get('dim_divisor') || 5000; const lengthInputs = formData.getAll('length[]'); const widthInputs = formData.getAll('width[]'); const heightInputs = formData.getAll('height[]'); const weightInputs = formData.getAll('weight[]');
                        for(let i = 0; i < lengthInputs.length; i++) { reweightData.dimensions.push({ length: lengthInputs[i], width: widthInputs[i] || '', height: heightInputs[i], weight: weightInputs[i] }); }
                        console.log('Đã xác nhận thông số Reweight:', reweightData);
                        if (packageContentDisplayReweight && reweightData.product_name) packageContentDisplayReweight.textContent = reweightData.product_name;
                        const reweightDisplays = [reweightDisplay1, reweightDisplay2, reweightDisplay3]; const actualDimCalcDisplays = [actualDimCalcDisplay1, actualDimCalcDisplay2, actualDimCalcDisplay3]; const actualConvertedDisplays = [actualConvertedWeightDisplay1, actualConvertedWeightDisplay2, actualConvertedWeightDisplay3];
                        reweightData.dimensions.forEach((dim, index) => { if (reweightDisplays[index]) reweightDisplays[index].textContent = `${dim.weight || '0'} KG`; const l = parseFloat(dim.length) || 0; const w = parseFloat(dim.width) || 0; const h = parseFloat(dim.height) || 0; const divisor = parseInt(reweightData.dim_divisor, 10); const converted = divisor > 0 ? (l * w * h) / divisor : 0; if (actualDimCalcDisplays[index]) { actualDimCalcDisplays[index].innerHTML = `<b>${l}</b>x<b>${w}</b>x<b>${h}</b>/${divisor}= ${converted.toFixed(2)} KG`; } if (actualConvertedDisplays[index]) { actualConvertedDisplays[index].textContent = `${converted.toFixed(2)} KG`; } });
                        alert('Đã cập nhật thông tin Reweight. Xem Console (F12).'); closeEditModal();
                    });
                }
            }

            async function openOpsItemsModal() { await loadModalContent('../form_package_detail/ops-item-details.html', populateOpsItemsModalData, attachOpsItemsModalListeners); }
            function populateOpsItemsModalData(container){
                const packageSelectModal = container.querySelector('#packageSelectModal');
                if (packageSelectModal && packageCountSelectOps) { const selectedText = packageCountSelectOps.options[packageCountSelectOps.selectedIndex].text; const packageNumberMatch = selectedText.match(/Kiện\s*(\d+)/); if (packageNumberMatch) packageSelectModal.value = packageNumberMatch[1]; }
            }
            function attachOpsItemsModalListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button'); const confirmButton = container.querySelector('.modal-confirm-button');
                const formContainer = container.querySelector('.agent-item-details-form');
                if (!formContainer) return;
                if (cancelButton) { const newCancelButton = cancelButton.cloneNode(true); cancelButton.parentNode.replaceChild(newCancelButton, cancelButton); newCancelButton.addEventListener('click', closeEditModal); }
                if (confirmButton) {
                    const newConfirmButton = confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
                    newConfirmButton.addEventListener('click', () => {
                        const items = []; const rows = formContainer.querySelectorAll('.modal-item-table tbody tr'); let grandTotal = 0;
                        rows.forEach(row => { const nameEl = row.querySelector('.item-name'); const qtyEl = row.querySelector('.item-qty'); const unitEl = row.querySelector('.item-unit'); const priceEl = row.querySelector('.item-price'); const totalEl = row.querySelector('.item-total'); if (nameEl && qtyEl && unitEl && priceEl && totalEl) { const itemData = { name: nameEl.value, qty: qtyEl.value, unit: unitEl.value, price: priceEl.value, total: totalEl.value }; items.push(itemData); grandTotal += parseFloat(itemData.total) || 0; } });
                        console.log('Đã xác nhận chi tiết hàng hóa OPS (dữ liệu lấy từ modal):', { "Hàng hóa": items, "Tổng giá trị": grandTotal });
                        if (invoiceValueDisplayOps) invoiceValueDisplayOps.textContent = `${grandTotal.toFixed(0)} USD`;
                        alert('Đã cập nhật chi tiết hàng hóa OPS. Tổng giá trị đã được cập nhật. Xem Console (F12).'); closeEditModal();
                    });
                }
            }

            async function openAgentContentModal() { await loadModalContent('../form_package_detail/edit-package-reweight.html', populateAgentContentModalData, attachAgentContentModalListeners); }
            function populateAgentContentModalData(container){
                 const modalTitle = container.querySelector('.form-header h2'); if (modalTitle) modalTitle.textContent = 'Nhập cân nặng Đại lý';
                 const productNameInputModal = container.querySelector('#productNameModal'); const dimDivisorInputModal = container.querySelector('#dimDivisorModal'); const dimensionsContainerModal = container.querySelector('#dimensionsContainerModal');
                 if (productNameInputModal && agentContentDisplay) productNameInputModal.value = agentContentDisplay.textContent.trim();
                 if (dimDivisorInputModal) { const calcText = agentDimCalcDisplay1 ? agentDimCalcDisplay1.textContent : ''; const dimMatch = calcText.match(/\/(\d+)/); dimDivisorInputModal.value = dimMatch ? dimMatch[1] : "5000"; }
                 if (dimensionsContainerModal) { let modalRows = dimensionsContainerModal.querySelectorAll('.dimension-row'); const agentDimCalcElements = [agentDimCalcDisplay1, agentDimCalcDisplay2, agentDimCalcDisplay3]; const agentReweightValueElements = [agentReweightValueDisplay1, agentReweightValueDisplay2, agentReweightValueDisplay3]; const dataRowCount = agentDimCalcElements.filter(el => el && el.textContent.trim() !== '').length; while(modalRows.length > dataRowCount && modalRows.length > 1) { modalRows[modalRows.length - 1].remove(); modalRows = dimensionsContainerModal.querySelectorAll('.dimension-row'); } while(modalRows.length < dataRowCount) { const addButton = container.querySelector('#btnAddDimRowModal'); if (addButton) addButton.click(); else break; modalRows = dimensionsContainerModal.querySelectorAll('.dimension-row'); } modalRows.forEach((row, index) => { const calcEl = agentDimCalcElements[index]; const weightEl = agentReweightValueElements[index]; const lengthInput = row.querySelector('input[name="length[]"]'); const widthInput = row.querySelector('input[name="width[]"]'); const heightInput = row.querySelector('input[name="height[]"]'); const weightInput = row.querySelector('input[name="weight[]"]'); if (calcEl) { const dimMatch = calcEl.textContent.match(/<b>(\d+(\.\d+)?)<\/b>\s*x\s*<b>(\d+(\.\d+)?)<\/b>\s*x\s*<b>(\d+(\.\d+)?)<\/b>/); if (dimMatch && lengthInput && widthInput && heightInput) { lengthInput.value = dimMatch[1] || ''; widthInput.value = dimMatch[3] || ''; heightInput.value = dimMatch[5] || ''; } } if (weightEl && weightInput) { const weightMatch = weightEl.textContent.match(/(\d+(\.\d+)?)/); weightInput.value = weightMatch ? weightMatch[1] : ''; } }); }
            }
            function attachAgentContentModalListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button'); const confirmButton = container.querySelector('.modal-confirm-button');
                const formElement = container.querySelector('#formPackageParamsModal');
                if (!formElement) return;
                if (cancelButton) { const newCancelButton = cancelButton.cloneNode(true); cancelButton.parentNode.replaceChild(newCancelButton, cancelButton); newCancelButton.addEventListener('click', closeEditModal); }
                if (confirmButton) {
                    const newConfirmButton = confirmButton.cloneNode(true); confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
                    newConfirmButton.addEventListener('click', () => {
                        const formData = new FormData(formElement); const agentData = { dimensions: [] }; agentData.product_name = formData.get('product_name'); agentData.dim_divisor = formData.get('dim_divisor') || 5000; const lengthInputs = formData.getAll('length[]'); const widthInputs = formData.getAll('width[]'); const heightInputs = formData.getAll('height[]'); const weightInputs = formData.getAll('weight[]');
                        for(let i = 0; i < lengthInputs.length; i++) { agentData.dimensions.push({ length: lengthInputs[i], width: widthInputs[i] || '', height: heightInputs[i], weight: weightInputs[i] }); }
                        console.log('Đã xác nhận cân nặng Đại lý:', agentData);
                        if (agentContentDisplay && agentData.product_name) agentContentDisplay.textContent = agentData.product_name;
                        const agentDimCalcDisplays = [agentDimCalcDisplay1, agentDimCalcDisplay2, agentDimCalcDisplay3]; const agentConvertedDisplays = [agentConvertedWeightDisplay1, agentConvertedWeightDisplay2, agentConvertedWeightDisplay3]; const agentReweightValueDisplays = [agentReweightValueDisplay1, agentReweightValueDisplay2, agentReweightValueDisplay3];
                        agentData.dimensions.forEach((dim, index) => { if (agentReweightValueDisplays[index]) agentReweightValueDisplays[index].textContent = `${dim.weight || '0'} KG`; const l = parseFloat(dim.length) || 0; const w = parseFloat(dim.width) || 0; const h = parseFloat(dim.height) || 0; const divisor = parseInt(agentData.dim_divisor, 10); const converted = divisor > 0 ? (l * w * h) / divisor : 0; if (agentDimCalcDisplays[index]) { agentDimCalcDisplays[index].innerHTML = `<b>${l}</b>x<b>${w}</b>x<b>${h}</b>/${divisor}= ${converted.toFixed(2)} KG`; } if (agentConvertedDisplays[index]) { agentConvertedDisplays[index].textContent = `${converted.toFixed(2)} KG`; } });
                        alert('Đã cập nhật thông tin cân nặng Đại lý. Xem Console (F12).'); closeEditModal();
                    });
                }
            }

            // Add functions for Order Code, Creator and Notes modals
            async function openOrderCodeModal() { 
                console.log("Opening Order Code Modal..."); 
                await loadModalContent("../form_package_detail/edit-order-code.html", populateOrderCodeModalData, attachOrderCodeModalListeners); 
            }
            
            function populateOrderCodeModalData(container) {
                const orderCodeInput = container.querySelector('#orderCodeInput');
                // Find the first data-pair with a label containing "Mã đơn hàng"
                const orderCodeLabels = Array.from(document.querySelectorAll('.data-pair .label')).filter(el => 
                    el.textContent.includes('Mã đơn hàng'));
                const orderCodeDisplay = orderCodeLabels[0]?.nextElementSibling;
                
                if (orderCodeInput && orderCodeDisplay) {
                    orderCodeInput.value = orderCodeDisplay.textContent.trim();
                }
            }
            
            function attachOrderCodeModalListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button');
                const confirmButton = container.querySelector('.modal-confirm-button');
                
                if (cancelButton) cancelButton.addEventListener('click', closeEditModal);
                if (confirmButton) {
                    confirmButton.addEventListener('click', () => {
                        const orderCodeInput = container.querySelector('#orderCodeInput');
                        const orderCodeLabels = Array.from(document.querySelectorAll('.data-pair .label')).filter(el => 
                            el.textContent.includes('Mã đơn hàng'));
                        const orderCodeDisplay = orderCodeLabels[0]?.nextElementSibling;
                        
                        if (orderCodeInput && orderCodeDisplay) {
                            orderCodeDisplay.textContent = orderCodeInput.value;
                            alert('Đã cập nhật mã đơn hàng thành công!');
                        }
                        closeEditModal();
                    });
                }
            }
            
            async function openCreatorModal() {
                console.log("Opening Creator Modal...");
                await loadModalContent("../form_package_detail/edit-creator.html", populateCreatorModalData, attachCreatorModalListeners);
            }
            
            function populateCreatorModalData(container) {
                const creatorSelect = container.querySelector('#creatorSelect');
                const creatorInput = container.querySelector('#creatorInput');
                
                // Find the data-pair with a label containing "Người tạo"
                const creatorLabels = Array.from(document.querySelectorAll('.data-pair .label')).filter(el => 
                    el.textContent.includes('Người tạo'));
                const creatorDisplay = creatorLabels[0]?.nextElementSibling;
                
                if (creatorDisplay) {
                    const currentCreator = creatorDisplay.textContent.trim();
                    if (creatorSelect) {
                        // Try to match with select options
                        const option = Array.from(creatorSelect.options).find(opt => opt.value === currentCreator);
                        if (option) {
                            option.selected = true;
                        } else if (creatorInput) {
                            // If not in dropdown, put in custom input
                            creatorInput.value = currentCreator;
                        }
                    }
                }
            }
            
            function attachCreatorModalListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button');
                const confirmButton = container.querySelector('.modal-confirm-button');
                
                if (cancelButton) cancelButton.addEventListener('click', closeEditModal);
                if (confirmButton) {
                    confirmButton.addEventListener('click', () => {
                        const creatorSelect = container.querySelector('#creatorSelect');
                        const creatorInput = container.querySelector('#creatorInput');
                        
                        // Find the data-pair with a label containing "Người tạo"
                        const creatorLabels = Array.from(document.querySelectorAll('.data-pair .label')).filter(el => 
                            el.textContent.includes('Người tạo'));
                        const creatorDisplay = creatorLabels[0]?.nextElementSibling;
                        
                        let creator = creatorInput.value.trim();
                        if (!creator && creatorSelect) {
                            creator = creatorSelect.value;
                        }
                        
                        if (creatorDisplay && creator) {
                            creatorDisplay.textContent = creator;
                            alert('Đã cập nhật thông tin người tạo thành công!');
                        }
                        closeEditModal();
                    });
                }
            }
            
            async function openNotesModal() {
                console.log("Opening Notes Modal...");
                await loadModalContent("../form_package_detail/edit-notes.html", populateNotesModalData, attachNotesModalListeners);
            }
            
            function populateNotesModalData(container) {
                const notesInput = container.querySelector('#notesInput');
                
                // Find the data-pair with a label containing "Ghi chú"
                const notesLabels = Array.from(document.querySelectorAll('.data-pair .label')).filter(el => 
                    el.textContent.includes('Ghi chú'));
                const notesDisplay = notesLabels[0]?.nextElementSibling;
                
                if (notesInput && notesDisplay) {
                    notesInput.value = notesDisplay.textContent.trim();
                }
            }
            
            function attachNotesModalListeners(container) {
                const cancelButton = container.querySelector('.modal-cancel-button');
                const confirmButton = container.querySelector('.modal-confirm-button');
                
                if (cancelButton) cancelButton.addEventListener('click', closeEditModal);
                if (confirmButton) {
                    confirmButton.addEventListener('click', () => {
                        const notesInput = container.querySelector('#notesInput');
                        
                        // Find the data-pair with a label containing "Ghi chú"
                        const notesLabels = Array.from(document.querySelectorAll('.data-pair .label')).filter(el => 
                            el.textContent.includes('Ghi chú'));
                        const notesDisplay = notesLabels[0]?.nextElementSibling;
                        
                        if (notesInput && notesDisplay) {
                            notesDisplay.textContent = notesInput.value;
                            alert('Đã cập nhật ghi chú thành công!');
                        }
                        closeEditModal();
                    });
                }
            }

            function toggleNotificationDropdown() { if (notificationDropdown) notificationDropdown.classList.toggle('visible'); }
            function closeNotificationDropdown() { if (notificationDropdown) notificationDropdown.classList.remove('visible'); }
            function showAnnouncement() { if (announcementOverlay) { announcementOverlay.classList.add('visible'); manageBodyScroll(); } }
            function closeAnnouncement() { if (announcementOverlay) { announcementOverlay.classList.remove('visible'); manageBodyScroll(); } }

            initializeActiveSubmenu();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            initializeSectionToggles();
            if (announcementOverlay && announcementOverlay.classList.contains('visible')) closeAnnouncement();

            if (mobileSidebarToggleBtn) mobileSidebarToggleBtn.addEventListener('click', toggleSidebarMobileOrDesktop);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebarMobileOrDesktop);
            if (desktopSidebarToggleBtn) desktopSidebarToggleBtn.addEventListener('click', toggleSidebarDesktop);
            document.querySelectorAll('.menu-items .submenu-parent').forEach(link => link.addEventListener('click', toggleSubmenu));
            if (fullscreenBtn) fullscreenBtn.addEventListener('click', toggleFullscreen);
            document.addEventListener('fullscreenchange', handleFullscreenChange);

            if (openModalTrigger) openModalTrigger.addEventListener('click', openEditModal);
            if (openAgentItemsTrigger) openAgentItemsTrigger.addEventListener('click', openAgentItemsModal);
            if (openPackageParamsTrigger) openPackageParamsTrigger.addEventListener('click', openPackageParamsModal);
            if (openServiceInfoTrigger) openServiceInfoTrigger.addEventListener('click', openServiceInfoModal);
            if (openReceiverInfoTrigger) openReceiverInfoTrigger.addEventListener('click', openReceiverInfoModal);
            if (openAgentReweightTrigger) openAgentReweightTrigger.addEventListener('click', openAgentReweightModal);
            if (openOpsItemsTrigger) openOpsItemsTrigger.addEventListener('click', openOpsItemsModal);
            if (openAgentContentTrigger) openAgentContentTrigger.addEventListener('click', openAgentContentModal);
            if (adjustChargesTriggerButton) adjustChargesTriggerButton.addEventListener('click', openAdjustProfitModal);
            if (editProfitTriggerButton) editProfitTriggerButton.addEventListener('click', openAdjustProfitModal);

            // Add event listeners for the edit buttons
            document.querySelectorAll('.edit-value-icon').forEach(button => {
                const title = button.getAttribute('title');
                if (title && title.includes('Chỉnh sửa Mã đơn')) {
                    button.addEventListener('click', openOrderCodeModal);
                    console.log("Added order code edit button listener");
                } else if (button.closest('.data-pair') && 
                           button.closest('.data-pair').querySelector('.label') && 
                           button.closest('.data-pair').querySelector('.label').textContent.includes('Người tạo')) {
                    button.addEventListener('click', openCreatorModal);
                    console.log("Added creator edit button listener");
                } else if (title && title.includes('Chỉnh sửa ghi chú')) {
                    button.addEventListener('click', openNotesModal);
                    console.log("Added notes edit button listener");
                }
            });

            if (notificationButton) {
                notificationButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    toggleNotificationDropdown();
                });
            }
            if (notificationList) {
                notificationList.addEventListener('click', (event) => {
                    const clickedItem = event.target.closest('.notification-item');
                    if (clickedItem && announcementTitle && announcementBodyEl && announcementTimestamp) {
                        const title = clickedItem.dataset.title || 'Thông báo';
                        const bodyText = clickedItem.dataset.body || 'Không có nội dung.';
                        const timestamp = clickedItem.dataset.timestamp || '';

                        announcementTitle.textContent = title;
                        announcementBodyEl.innerHTML = '';
                        bodyText.split('||').forEach(paragraphText => {
                            if(paragraphText.trim()) {
                                const p = document.createElement('p');
                                p.textContent = paragraphText.trim();
                                announcementBodyEl.appendChild(p);
                            }
                        });
                        announcementTimestamp.textContent = timestamp;
                        showAnnouncement();
                        closeNotificationDropdown();
                    }
                });
            }
            document.addEventListener('click', (event) => {
                if (notificationDropdown?.classList.contains('visible') && !notificationDropdown.contains(event.target) && !notificationButton?.contains(event.target)) {
                    closeNotificationDropdown();
                }
            });
            if (announcementCloseBtn) {
                announcementCloseBtn.addEventListener('click', closeAnnouncement);
            }
            if (announcementOverlay) {
                announcementOverlay.addEventListener('click', (event) => {
                    if (event.target === announcementOverlay) {
                        closeAnnouncement();
                    }
                });
            }

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (announcementOverlay?.classList.contains('visible')) closeAnnouncement();
                    else if (modalOverlay?.classList.contains('active')) closeEditModal();
                    else if (notificationDropdown?.classList.contains('visible')) closeNotificationDropdown();
                }
            });

            console.log("All initializations complete for Unified Order Detail Page.");
        });

        // --- Dropdown user đăng nhập/đăng xuất ---
        document.addEventListener('DOMContentLoaded', function() {
            function renderUserDropdown() {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const userToggle = document.getElementById('user-dropdown-toggle');
                const userDropdown = document.getElementById('user-dropdown');
                if (!userToggle || !userDropdown) return;
                if (!isLoggedIn) {
                    userToggle.innerHTML = `
                        <div style="background: linear-gradient(135deg, #ffe066 0%, #a78bfa 100%); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-regular fa-circle-user user-icon" style="color: #4F46E5; font-size: 1.5em;"></i>
                        </div>
                    `;
                    userDropdown.innerHTML = `
                        <a href="#" class="user-dropdown-item" id="login-menu-item">
                            <i class="fa-solid fa-right-to-bracket"></i> Đăng nhập
                        </a>
                    `;
                } else {
                    userToggle.innerHTML = `
                        <div style="background: linear-gradient(135deg, #ffe066 0%, #a78bfa 100%); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-regular fa-circle-user user-icon" style="color: #4F46E5; font-size: 1.5em;"></i>
                        </div>
                    `;
                    userDropdown.innerHTML = `
                        <div class="user-info">
                            <div class="user-avatar"><i class="fa-regular fa-circle-user"></i></div>
                            <div class="user-details">
                                <div>Phạm Hoàng Đình</div>
                                <div>Quản trị viên</div>
                            </div>
                        </div>
                        <hr>
                        <a href="#" class="user-dropdown-item"><i class="fa-regular fa-user"></i> Thông tin cá nhân</a>
                        <a href="#" class="user-dropdown-item"><i class="fa-solid fa-gear"></i> Cài đặt tài khoản</a>
                        <a href="#" class="user-dropdown-item"><i class="fa-solid fa-bell"></i> Thông báo</a>
                        <a href="#" class="user-dropdown-item"><i class="fa-solid fa-shield-halved"></i> Bảo mật</a>
                        <hr>
                        <a href="#" class="user-dropdown-item" id="logout-menu-item"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a>
                    `;
                }
                setTimeout(() => {
                    const loginItem = document.getElementById('login-menu-item');
                    if (loginItem) loginItem.onclick = function(e) { e.preventDefault(); window.location.href = 'login.html'; };
                    const logoutItem = document.getElementById('logout-menu-item');
                    if (logoutItem) logoutItem.onclick = function(e) { e.preventDefault(); localStorage.removeItem('isLoggedIn'); window.location.reload(); };
                }, 100);
            }
            renderUserDropdown();
            window.addEventListener('storage', renderUserDropdown);
            // Dropdown show/hide
            const userToggle = document.getElementById('user-dropdown-toggle');
            const userDropdown = document.getElementById('user-dropdown');
            if(userToggle && userDropdown){
                userToggle.addEventListener('click', function(e){
                    e.stopPropagation();
                    userDropdown.classList.toggle('show');
                });
                document.addEventListener('click', function(e){
                    if(!userDropdown.contains(e.target) && e.target !== userToggle){
                        userDropdown.classList.remove('show');
                    }
                });
            }
        });
    </script>

</body>
</html>