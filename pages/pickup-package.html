<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pickup Đơn Hàng - Minh Khôi Logistics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="../css/package_manager.css">
    <link rel="stylesheet" href="../css/pickup-package.css">
    <link href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.6/dist/css/tempus-dominus.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.6/dist/js/tempus-dominus.min.js"></script>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../images/newlogo2-removebg.png" alt="Mien Tay Express Logo" class="logo">
        </div>
        <nav class="menu-items" aria-label="Main Navigation">
             <ul>
                 <li><a href="../index.html"><i class="fa-solid fa-house icon"></i><span class="menu-text">TRANG CHỦ</span></a></li>
                 <li><a href="create-package.html"><i class="fa-solid fa-plus icon"></i><span class="menu-text">TẠO ĐƠN HÀNG</span></a></li>
                 <li>
                     <a href="#" class="submenu-parent"> <i class="fa-solid fa-chart-pie icon"></i><span class="menu-text">QUẢN LÝ</span><i class="fa-solid fa-chevron-down submenu-arrow"></i> </a>
                     <div class="submenu">
                         <ul>
                             <li><a href="package_manager.html"><i class="fa-solid fa-box-archive icon"></i><span class="menu-text">Quản lý đơn hàng</span></a></li>
                             <li><a href="straking-bill-of-lading-status.html"><i class="fa-solid fa-list-check icon"></i><span class="menu-text">Quản lý trạng thái</span></a></li>
                             <li><a href="pickup-package.html" class="active"><i class="fa-solid fa-truck-fast icon"></i><span class="menu-text">Quản lý vận chuyển</span></a></li>
                             <li><a href="#"><i class="fa-solid fa-building-user icon"></i><span class="menu-text">Quản lý chi nhánh</span></a></li>
                             <li><a href="payment-management.html"><i class="fa-solid fa-dollar-sign icon"></i><span class="menu-text">Quản lý thanh toán</span></a></li>
                         </ul>
                     </div>
                 </li>
                 <li><a href="statistics_management.html"><i class="fa-solid fa-chart-line icon"></i><span class="menu-text">THỐNG KÊ</span></a></li>
                 <li><a href="service-management.html"><i class="fa-solid fa-screwdriver-wrench icon"></i><span class="menu-text">QL DỊCH VỤ</span></a></li>
                 <li><a href="customer-list.html"><i class="fa-solid fa-users icon"></i><span class="menu-text">QL KHÁCH HÀNG</span></a></li>
                 <li><a href="employee-list.html"><i class="fa-solid fa-user-tie icon"></i><span class="menu-text">QUẢN LÝ NHÂN SỰ</span></a></li>
                 <li><a href="#"><i class="fa-solid fa-circle-info icon"></i><span class="menu-text">THÔNG TIN CÔNG TY</span></a></li>
                  <li>
                      <a href="#" class="submenu-parent"><i class="fa-solid fa-scroll icon"></i><span class="menu-text">QL CHÍNH SÁCH</span><i class="fa-solid fa-chevron-down submenu-arrow"></i></a>
                       <div class="submenu">
                          <ul>
                              <li><a href="#"><span class="menu-text">Chính sách A</span></a></li>
                              <li><a href="#"><span class="menu-text">Chính sách B</span></a></li>
                          </ul>
                      </div>
                  </li>
                 <li><a href="#"><i class="fa-solid fa-circle-question icon"></i><span class="menu-text">HƯỚNG DẪN SỬ DỤNG</span></a></li>
                 <li>
                     <a href="#" class="submenu-parent"><i class="fa-solid fa-gear icon"></i><span class="menu-text">CÀI ĐẶT CHUNG</span><i class="fa-solid fa-chevron-down submenu-arrow"></i></a>
                      <div class="submenu">
                          <ul>
                             <li><a href="#"><span class="menu-text">Cài đặt A</span></a></li>
                             <li><a href="#"><span class="menu-text">Cài đặt B</span></a></li>
                          </ul>
                      </div>
                  </li>
             </ul>
         </nav>
    </aside>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <main class="main-content">
        <header class="header">
            <button class="mobile-sidebar-toggle" id="mobile-sidebar-toggle" aria-label="Toggle Navigation Menu" aria-controls="sidebar" aria-expanded="false"> <i class="fa-solid fa-bars"></i> </button>
            <div class="header-left">
                <div class="search-container">
                    <i class="fa-solid fa-magnifying-glass search-icon"></i>
                    <input type="text" class="header-search-input" placeholder="Mã vận đơn / Tracking ID...">
                </div>
            </div>
            <div class="header-actions" style="display: flex; align-items: center; gap: 1.2rem; margin-left: auto;">
                <div class="notification-wrapper">
                    <button class="notification-button" id="notification-button" title="Thông báo">
                        <i class="fa-regular fa-bell"></i>
                        <span class="notification-badge">5</span>
                    </button>
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="dropdown-header">Thông báo</div>
                        <ul class="notification-list" id="notification-list">
                            <li class="notification-item" data-title="Thông báo: DỜI CUT OFF CANADA 24/08/2024" data-body="Do lượng hàng T7 (24/08/2024) không đủ tải, chuyến tuyến MTE-CAD sẽ kết nối hàng vào chuyến bay sớm nhất (Cs sẽ update giờ cut off mới)||MTE xin lỗi Quý khách vì sự chậm trễ gây ra bất tiện cho khách hàng.||Rất mong nhận sự thông cảm của Quý khách hàng.||Cs tuyến Canada." data-timestamp="2024-07-25 13:53:27">
                                <div class="item-icon"><i class="fa-solid fa-calendar-xmark"></i></div>
                                <div class="item-content">
                                    <div class="item-title">Dời Cut off Canada 24/08/2024</div>
                                    <div class="item-time">25 Jul 2024</div>
                                </div>
                            </li>
                            <li class="notification-item" data-title="Thông báo: Cập nhật hệ thống" data-body="Hệ thống sẽ được bảo trì vào lúc 02:00 AM ngày 30/07/2024. Vui lòng lưu lại công việc trước thời gian này." data-timestamp="2024-07-28 10:00:00">
                                <div class="item-icon"><i class="fa-solid fa-wrench"></i></div>
                                <div class="item-content">
                                    <div class="item-title">Cập nhật hệ thống 30/07</div>
                                    <div class="item-time">28 Jul 2024</div>
                                </div>
                            </li>
                            <li class="notification-item" data-title="Thông báo: Khuyến mãi mới" data-body="Chương trình khuyến mãi hè 2024 đã bắt đầu! Giảm giá 10% cho các tuyến đi Mỹ." data-timestamp="2024-07-20 09:00:00">
                                <div class="item-icon"><i class="fa-solid fa-tags"></i></div>
                                <div class="item-content">
                                    <div class="item-title">Khuyến mãi hè 2024!</div>
                                    <div class="item-time">20 Jul 2024</div>
                                </div>
                            </li>
                        </ul>
                        <div class="dropdown-footer"><a href="#">Xem tất cả</a></div>
                    </div>
                </div>
                <div class="user-container" style="position: relative;">
                    <div class="user-dropdown-toggle" id="user-dropdown-toggle" style="display: flex; align-items: center; gap: 6px; background: #6366f1; border-radius: 7px; padding: 6px 14px; cursor: pointer;">
                        <i class="fa-regular fa-circle-user user-icon" id="user-icon" style="color: #fff; font-size: 1.25em;"></i>
                    </div>
                    <div class="user-dropdown" id="user-dropdown">
                        <a href="#" class="user-dropdown-item" id="profile-link"><i class="fa-regular fa-user"></i> Profile</a>
                        <a href="#" class="user-dropdown-item" id="login-link"><i class="fa-solid fa-right-to-bracket"></i> Đăng nhập</a>
                        <a href="#" class="user-dropdown-item" id="logout-link"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a>
                    </div>
                </div>
            </div>
        </header>

        <div class="content-wrapper">
            <section class="page-header">
                <div class="page-header-left">
                    <h1 class="page-title">PICKUP ĐƠN HÀNG</h1>
                    <nav class="breadcrumb" aria-label="breadcrumb"> <a href="#">Quản lý</a> / <span>Quản lý vận chuyển</span> / <span>Pickup Đơn Hàng</span> </nav>
                </div>
            </section>
            <div class="progress-steps">
                <div class="step completed">
                    <div class="step-icon">
                        <i class="fa-solid fa-file-pen"></i>
                    </div>
                    <div class="step-label">Tạo đơn hàng bước 1</div>
                </div>
                <div class="step completed">
                    <div class="step-icon">
                        <i class="fa-solid fa-box"></i>
                    </div>
                    <div class="step-label">Tạo đơn hàng bước 2</div>
                </div>
                <div class="step completed">
                    <div class="step-icon">
                        <i class="fa-solid fa-circle-info"></i>
                    </div>
                    <div class="step-label">Chi tiết đơn hàng</div>
                </div>
                <div class="step active">
                    <div class="step-icon">
                        <i class="fa-solid fa-truck-fast"></i>
                    </div>
                    <div class="step-label">Tạo pickup</div>
                </div>
            </div>
            <form id="pickup-order-form">
                <div class="content-layout card">
                    <div class="content-column-left">
                         <div class="data-section">
                            <div class="section-header"><span><i class="fa-solid fa-truck"></i> Hình thức lấy hàng</span></div>
                            <div class="form-group"> <label for="pickup_vehicle">Hình thức vận chuyển:</label> <select id="pickup_vehicle" name="pickup_vehicle"> <option value="minivan" selected>Xe bán tải / Minivan</option> <option value="motorbike">Xe máy</option> <option value="truck">Xe tải</option> </select> </div>
                            <div class="form-group"> <label for="pickup_time">Thời gian Pickup:</label> <div class="input-with-icon"> <input type="text" id="pickup_time" name="pickup_time"> </div> </div>
                            <div class="form-group"> <label for="pickup_address">Địa chỉ lấy hàng:</label> <textarea id="pickup_address" name="pickup_address" rows="3">Căn nhà số 4, Đường B4, Phường An Lợi Đông, Thành phố Thủ Đức, Thành phố Hồ Chí Minh</textarea> </div>
                            <div class="form-group"> <label for="pickup_notes">Ghi chú lấy hàng:</label> <textarea id="pickup_notes" name="pickup_notes" rows="2">Nhờ chụp lại ảnh kiện nhé Alice</textarea> </div>
                         </div>
                         <div class="data-section">
                             <div class="section-header"><span><i class="fa-solid fa-clipboard-check"></i> Trạng thái lấy hàng</span></div>
                             <div class="form-grid-2col">
                                <div class="form-group"> <label for="pickup_status">Trạng thái lấy hàng:</label> <select id="pickup_status" name="pickup_status"> <option value="pending" selected>Chờ lấy hàng</option> <option value="picked_up">Đã lấy hàng</option> <option value="failed">Lấy thất bại</option> </select> </div>
                                <div class="form-group"> <label for="pickup_cs">CS xử lý:</label> <select id="pickup_cs" name="pickup_cs"> <option value="alice" selected>Alice in the Wonder La...</option> </select> </div>
                            </div>
                            <div class="form-group"> <label for="received_time">Thời gian nhận hàng:</label> <div class="input-with-icon"> <input type="text" id="received_time" name="received_time"> </div> </div>
                            <div class="form-group"> <label for="export_time">Thời gian xuất hàng:</label> <div class="input-with-icon"> <input type="text" id="export_time" name="export_time"> </div> </div>
                            <div class="form-group"> <label for="status_notes">Ghi chú:</label> <textarea id="status_notes" name="status_notes" rows="2"></textarea> </div>
                            <div class="form-group">
                                <label>Ảnh đính kèm:</label>
                                <div class="attachment-group">
                                    <button type="button" class="file-trigger-button button secondary" id="select_images_btn"> <i class="fa-solid fa-image"></i> Chọn ảnh </button>
                                    <input type="file" id="pickup_images" name="pickup_images[]" multiple accept="image/jpeg, image="image/png", image="image/gif" style="display: none;">
                                    <span class="file-type-note">(.jpg/.png/.jpeg)</span>
                                </div>
                                <div id="selected_files_list"><i>Chưa chọn file nào.</i></div>
                            </div>
                         </div>
                    </div>

                    <div class="content-column-right">
                        <div class="data-section">
                            <div class="section-header">
                                <span><i class="fa-solid fa-circle-info"></i> Thông tin đơn hàng</span>
                                <div class="creator-info" id="order-creator-info">Người tạo: </div>
                            </div>
                            <div class="readonly-info-section" id="order-info-dynamic">
                                <!-- Thông tin đơn hàng sẽ được render ở đây bằng JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-actions card">
                    <div class="confirmation-check">
                        <input type="checkbox" id="confirm_info_pickup" name="confirm_info_pickup" required checked>
                        <label for="confirm_info_pickup">Tôi đã đọc kỹ và kiểm tra thông tin đầy đủ</label>
                    </div>
                    <div class="action-buttons">
                        <button type="button" class="button secondary" onclick="window.history.back();"> <i class="fa-solid fa-xmark"></i> Thoát </button>
                        <button type="reset" class="button warning" form="pickup-order-form"> <i class="fa-solid fa-arrows-rotate"></i> Làm mới </button>
                        <button type="button" class="button info btn-save-draft"> <i class="fa-solid fa-floppy-disk"></i> Lưu nháp </button>
                        <button type="submit" class="button confirm btn-complete" form="pickup-order-form"> <i class="fa-solid fa-check"></i> Hoàn thành </button>
                    </div>
                </div>
            </form>

            <footer class="site-footer">
                Minh Khôi Logistics © <span id="current-year"></span>. All rights reserved. Design by Nina Co.,Ltd
            </footer>
        </div>
    </main>

    <div class="confirmation-modal" id="complete-order-modal"></div>
    <div class="confirmation-modal" id="cancel-order-modal"></div>
    <div class="confirmation-modal" id="receive-order-modal"></div>
    <div class="confirmation-modal" id="delete-order-modal"></div>

    <div class="announcement-overlay" id="announcement-overlay">
        <div class="announcement-box" id="announcement-box">
            <div class="announcement-header">
                <h3 id="announcement-title">Tiêu đề thông báo</h3>
                <button class="announcement-close-btn" id="announcement-close-btn" title="Đóng thông báo">×</button>
            </div>
            <div class="announcement-body" id="announcement-body">
                Nội dung chi tiết của thông báo sẽ được hiển thị ở đây.
            </div>
            <div class="announcement-footer">
                <span id="announcement-timestamp">Thời gian</span>
            </div>
        </div>
    </div>

    <script>
        const body = document.body;
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const mobileSidebarToggleBtn = document.getElementById('mobile-sidebar-toggle');
        const desktopSidebarToggleBtn = document.querySelector('.sidebar-toggle-desktop');
        const currentDateSpan = document.getElementById('current-date');
        const currentTimeSpan = document.getElementById('current-time');
        const currentYearSpan = document.getElementById('current-year');
        const fullscreenBtn = document.getElementById('fullscreen-btn');

        const isElementVisible = (el) => el && !el.hasAttribute('hidden') && el.offsetParent !== null;

        const manageBodyScroll = () => {
            const isSidebarOpen = body.classList.contains('sidebar-mobile-open');
            const isAnyModalVisible = document.querySelector('.confirmation-modal.visible, .announcement-overlay.visible');
            if (isSidebarOpen || isAnyModalVisible) {
                body.classList.add('overflow-hidden');
            } else {
                body.classList.remove('overflow-hidden');
            }
        };

        function toggleSidebarMobileOrDesktop() {
            if (window.innerWidth > 768) {
                body.classList.toggle('sidebar-collapsed');
            } else {
                body.classList.toggle('sidebar-mobile-open');
            }
            const isOpen = body.classList.contains('sidebar-mobile-open') || !body.classList.contains('sidebar-collapsed');
            if (mobileSidebarToggleBtn) mobileSidebarToggleBtn.setAttribute('aria-expanded', String(isOpen));
            manageBodyScroll();
        }

        function toggleSidebarDesktop() {
            body.classList.toggle('sidebar-collapsed');
            const isCollapsed = body.classList.contains('sidebar-collapsed');
            if (desktopSidebarToggleBtn) {
                desktopSidebarToggleBtn.title = isCollapsed ? "Phóng Sidebar" : "Thu Sidebar";
                const icon = desktopSidebarToggleBtn.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-arrow-left', !isCollapsed);
                    icon.classList.toggle('fa-arrow-right', isCollapsed);
                }
            }
            if (isCollapsed && window.innerWidth > 768) {
                document.querySelectorAll('.menu-items .submenu.active').forEach(submenu => {
                    submenu.classList.remove('active');
                    const parentLink = submenu.previousElementSibling;
                    if(parentLink && parentLink.classList.contains('submenu-parent')) {
                        parentLink.classList.remove('active');
                        parentLink.querySelector('.submenu-arrow')?.style.setProperty('transform', 'rotate(0deg)');
                    }
                });
            } else {
                 initializeActiveSubmenu();
            }
        }

        function toggleSubmenu(event) {
            event.preventDefault();
            if (body.classList.contains('sidebar-collapsed') && window.innerWidth > 768) {
                return;
            }
            const parentLink = event.currentTarget;
            const submenuWrapper = parentLink.nextElementSibling;
            const arrow = parentLink.querySelector('.submenu-arrow');
            if (!submenuWrapper || !submenuWrapper.classList.contains('submenu')) return;
            const isActive = submenuWrapper.classList.contains('active');

            document.querySelectorAll('.menu-items .submenu-parent.active').forEach(activeParent => {
                if (activeParent !== parentLink) {
                    activeParent.classList.remove('active');
                    const otherSubmenu = activeParent.nextElementSibling;
                     if (otherSubmenu && otherSubmenu.classList.contains('submenu')) {
                         otherSubmenu.classList.remove('active');
                     }
                     const otherArrow = activeParent.querySelector('.submenu-arrow');
                     if (otherArrow) otherArrow.style.setProperty('transform', 'rotate(0deg)');
                }
            });

            submenuWrapper.classList.toggle('active');
            parentLink.classList.toggle('active', !isActive);
             if (arrow) arrow.style.setProperty('transform', !isActive ? 'rotate(180deg)' : 'rotate(0deg)');
        }

        function initializeActiveSubmenu() {
            document.querySelectorAll('.menu-items .submenu-parent').forEach(parentLink => {
                 const submenuDiv = parentLink.nextElementSibling;
                 const arrow = parentLink.querySelector('.submenu-arrow');
                 if (submenuDiv?.classList.contains('submenu')) {
                     const hasActiveChild = submenuDiv.querySelector('a.active');
                     const shouldBeActive = hasActiveChild && (!body.classList.contains('sidebar-collapsed') || window.innerWidth <= 768);

                     submenuDiv.classList.toggle('active', shouldBeActive);
                     parentLink.classList.toggle('active', shouldBeActive);
                     if (arrow) arrow.style.setProperty('transform', shouldBeActive ? 'rotate(180deg)' : 'rotate(0deg)');
                 }
            });
        }

        function showConfirmationModal(modalId, targetInfo = {}) {
            const modal = document.getElementById(modalId);
            if (!modal) { console.error("Modal not found:", modalId); return; }
            modal.dataset.targetInfo = JSON.stringify(targetInfo);
            modal.classList.add('visible');
            manageBodyScroll();
        }

        function hideConfirmationModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                delete modal.dataset.targetInfo;
                modal.classList.remove('visible');
                manageBodyScroll();
            }
        }

        function updateDateTime() {
            const now = new Date();
            const optionsDate = { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' };
            const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
            try {
                if (currentDateSpan) currentDateSpan.textContent = now.toLocaleDateString('en-GB', optionsDate).replace(/,/g, '');
                if (currentTimeSpan) currentTimeSpan.textContent = now.toLocaleTimeString('en-US', optionsTime);
            } catch (e) {
                if (currentDateSpan) currentDateSpan.textContent = now.toLocaleDateString();
                if (currentTimeSpan) currentTimeSpan.textContent = now.toLocaleTimeString();
            }
            if (currentYearSpan) currentYearSpan.textContent = now.getFullYear();
        }

        function toggleFullscreen() {
             if (!document.fullscreenElement) {
                 document.documentElement.requestFullscreen().catch(err => console.error(`Fullscreen error: ${err.message} (${err.name})`));
             } else if (document.exitFullscreen) {
                 document.exitFullscreen();
             }
        }

        function handleFullscreenChange() {
             const isFullscreen = !!document.fullscreenElement;
             const icon = fullscreenBtn?.querySelector('i');
             if(icon){
                 icon.classList.toggle('fa-expand', !isFullscreen);
                 icon.classList.toggle('fa-compress', isFullscreen);
             }
              if(fullscreenBtn) {
                  fullscreenBtn.setAttribute('title', isFullscreen ? 'Exit Fullscreen' : 'Fullscreen');
              }
        }

        function handleFormSubmit(event) {
             event.preventDefault();
             const form = document.getElementById('pickup-order-form');
             const confirmCheckbox = document.getElementById('confirm_info_pickup');
             if (!form.checkValidity()) { form.reportValidity(); return; }
             if (!confirmCheckbox.checked) { alert('Vui lòng xác nhận đã đọc kỹ và kiểm tra thông tin.'); return false; }
             const formData = new FormData(form);
             const fileInput = document.getElementById('pickup_images');
             const displayedFilesList = document.getElementById('selected_files_list');
             const currentFiles = Array.from(fileInput.files);
             const displayedFileNames = Array.from(displayedFilesList.querySelectorAll('li [data-file-name]')).map(btn => btn.dataset.fileName);
             currentFiles.forEach(file => { if (displayedFileNames.includes(file.name)) { formData.append(fileInput.name, file); } });
             console.log('Submitting form data:');
             for (let [key, value] of formData.entries()) { if (value instanceof File) { console.log(`${key}: ${value.name}`); } else { console.log(`${key}: ${value}`); } }
              alert('Thông tin Pickup đã được hoàn thành (demo)!');
        }

        function handleSaveDraft() {
              console.log('Save Draft clicked');
              const form = document.getElementById('pickup-order-form');
              const formData = new FormData(form);
              console.log('Saving draft data:', Object.fromEntries(formData));
              alert('Đã lưu nháp thông tin (demo)!');
        }

        function handleFileSelection(event) {
             const fileListDisplay = document.getElementById('selected_files_list');
             const files = event.target.files;
             let existingFileNames = [];
             if (fileListDisplay.querySelector('ul')) { existingFileNames = Array.from(fileListDisplay.querySelectorAll('li [data-file-name]')).map(btn => btn.dataset.fileName); }
             const uniqueFilesMap = new Map();
             const originalFileInput = document.getElementById('pickup_images');
             Array.from(originalFileInput.files).forEach(file => { if (existingFileNames.includes(file.name)) { uniqueFilesMap.set(file.name, file); } });
             Array.from(files).forEach(file => { uniqueFilesMap.set(file.name, file); });
             fileListDisplay.innerHTML = '';
             if (uniqueFilesMap.size > 0) {
                 const list = document.createElement('ul');
                 uniqueFilesMap.forEach((file) => {
                     const listItem = document.createElement('li');
                     listItem.textContent = file.name;
                     const removeBtn = document.createElement('button');
                     removeBtn.type = 'button'; removeBtn.className = 'remove-file-btn'; removeBtn.innerHTML = '×'; removeBtn.title = 'Gỡ bỏ file này'; removeBtn.dataset.fileName = file.name; listItem.appendChild(removeBtn);
                     
                     // Create image preview element
                     const imgPreview = document.createElement('img');
                     imgPreview.style.maxWidth = '50px'; // Set max width for preview
                     imgPreview.style.maxHeight = '50px'; // Set max height for preview
                     imgPreview.style.marginRight = '10px'; // Add some space
                     imgPreview.style.verticalAlign = 'middle';
                     imgPreview.style.border = '1px solid #ddd'; // Optional border
                     imgPreview.style.borderRadius = '4px'; // Optional border radius
                     imgPreview.style.objectFit = 'cover'; // Cover the area without stretching
                     
                     // Use FileReader to read the image file
                     const reader = new FileReader();
                     reader.onload = function(e) {
                         imgPreview.src = e.target.result;
                     }
                     // Check if the file is an image before reading
                     if (file.type.startsWith('image/')) {
                         reader.readAsDataURL(file);
                         listItem.prepend(imgPreview); // Add image before text
                     } else {
                          // Optionally handle non-image files, maybe show a file icon
                          // For now, just add text content if not an image
                     }
                     
                     list.appendChild(listItem);
                 });
                 fileListDisplay.appendChild(list);
                 const dataTransfer = new DataTransfer();
                 uniqueFilesMap.forEach(file => dataTransfer.items.add(file));
                 originalFileInput.files = dataTransfer.files;
             } else {
                 fileListDisplay.innerHTML = '<i>Chưa chọn file nào.</i>';
                 originalFileInput.value = '';
             }
        }

        function handleRemoveFile(event) {
              if (event.target.classList.contains('remove-file-btn')) {
                  const fileNameToRemove = event.target.dataset.fileName;
                  const fileInput = document.getElementById('pickup_images');
                  const fileListDisplay = document.getElementById('selected_files_list');
                  const currentFiles = Array.from(fileInput.files);
                  const dataTransfer = new DataTransfer();
                  let fileRemoved = false;
                  currentFiles.forEach(file => { if (file.name !== fileNameToRemove) { dataTransfer.items.add(file); } else { fileRemoved = true; } });
                  fileInput.files = dataTransfer.files;
                  if (fileRemoved) { event.target.closest('li').remove(); }
                  if (!fileListDisplay.querySelector('li')) { fileListDisplay.innerHTML = '<i>Chưa chọn file nào.</i>'; }
                  console.log(`Removed ${fileNameToRemove}. Updated FileList:`, fileInput.files);
              }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeActiveSubmenu();
            updateDateTime();
            setInterval(updateDateTime, 1000);

            if (mobileSidebarToggleBtn) mobileSidebarToggleBtn.addEventListener('click', toggleSidebarMobileOrDesktop);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebarMobileOrDesktop);
            if (desktopSidebarToggleBtn) desktopSidebarToggleBtn.addEventListener('click', toggleSidebarDesktop);
            document.querySelectorAll('.menu-items .submenu-parent').forEach(link => link.addEventListener('click', toggleSubmenu));

            document.querySelectorAll('.confirmation-modal').forEach(modal => {
                const modalId = modal.id;
                modal.querySelector('.confirm-yes')?.addEventListener('click', () => {
                    const info = JSON.parse(modal.dataset.targetInfo || '{}');
                    console.log(`CONFIRMED: ${modalId}`, info);
                    hideConfirmationModal(modalId);
                 });
                modal.querySelector('.confirm-cancel')?.addEventListener('click', () => hideConfirmationModal(modalId));
                modal.addEventListener('click', (event) => { if (event.target === modal) hideConfirmationModal(modalId); });
            });

             if (fullscreenBtn) fullscreenBtn.addEventListener('click', toggleFullscreen);
             document.addEventListener('fullscreenchange', handleFullscreenChange);

            const form = document.getElementById('pickup-order-form');
            const saveDraftButton = document.querySelector('.btn-save-draft');
            const selectImagesBtn = document.getElementById('select_images_btn');
            const fileInput = document.getElementById('pickup_images');
            const fileListDisplay = document.getElementById('selected_files_list');

            if (form) form.addEventListener('submit', handleFormSubmit);
            if (saveDraftButton) saveDraftButton.addEventListener('click', handleSaveDraft);
            if (selectImagesBtn && fileInput) selectImagesBtn.addEventListener('click', () => fileInput.click() );
            if (fileInput && fileListDisplay) fileInput.addEventListener('change', handleFileSelection);
            if (fileListDisplay) fileListDisplay.addEventListener('click', handleRemoveFile);

             if (window.innerWidth > 768 && desktopSidebarToggleBtn) {
                  const isCollapsed = body.classList.contains('sidebar-collapsed');
                  const icon = desktopSidebarToggleBtn.querySelector('i');
                  if (icon) {
                    icon.classList.toggle('fa-arrow-left', !isCollapsed);
                    icon.classList.toggle('fa-arrow-right', isCollapsed);
                  }
             }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const notificationBody = document.body;
            const notificationButton = document.getElementById('notification-button');
            const notificationDropdown = document.getElementById('notification-dropdown');
            const notificationList = document.getElementById('notification-list');
            const announcementOverlay = document.getElementById('announcement-overlay');
            const announcementBox = document.getElementById('announcement-box');
            const announcementCloseBtn = document.getElementById('announcement-close-btn');
            const announcementTitle = document.getElementById('announcement-title');
            const announcementBodyEl = document.getElementById('announcement-body');
            const announcementTimestamp = document.getElementById('announcement-timestamp');

            const manageNotificationBodyScroll = () => {
                const isAnnounceVisible = announcementOverlay && announcementOverlay.classList.contains('visible');
                const isAnyOtherModalVisible = false;

                if (isAnnounceVisible || isAnyOtherModalVisible) {
                    notificationBody.classList.add('overflow-hidden');
                } else {
                    if (!isAnyOtherModalVisible) {
                         notificationBody.classList.remove('overflow-hidden');
                    }
                }
            };

            function toggleNotificationDropdown() {
                if (notificationDropdown) {
                    notificationDropdown.classList.toggle('visible');
                }
            }

            function closeNotificationDropdown() {
                 if (notificationDropdown) {
                    notificationDropdown.classList.remove('visible');
                 }
            }

            function showAnnouncement() {
                if (announcementOverlay) {
                    announcementOverlay.classList.add('visible');
                    manageNotificationBodyScroll();
                }
            }

            function closeAnnouncement() {
                if (announcementOverlay) {
                    announcementOverlay.classList.remove('visible');
                    manageNotificationBodyScroll();
                }
            }

            if (announcementOverlay && announcementOverlay.classList.contains('visible')) {
                closeAnnouncement();
            }

            if (notificationButton) {
                notificationButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    toggleNotificationDropdown();
                });
            }

            if (notificationList) {
                notificationList.addEventListener('click', (event) => {
                    const clickedItem = event.target.closest('.notification-item');
                    if (clickedItem && announcementTitle && announcementBodyEl && announcementTimestamp) {
                        const title = clickedItem.dataset.title || 'Thông báo';
                        const bodyText = clickedItem.dataset.body || 'Không có nội dung.';
                        const timestamp = clickedItem.dataset.timestamp || '';

                        announcementTitle.textContent = title;
                        announcementBodyEl.innerHTML = '';
                        bodyText.split('||').forEach(paragraphText => {
                            if(paragraphText.trim()) {
                                const p = document.createElement('p');
                                p.textContent = paragraphText.trim();
                                announcementBodyEl.appendChild(p);
                            }
                        });
                        announcementTimestamp.textContent = timestamp;
                        showAnnouncement();
                        closeNotificationDropdown();
                    }
                });
            }

            document.addEventListener('click', (event) => {
                if (notificationDropdown && notificationDropdown.classList.contains('visible')) {
                    if (!notificationDropdown.contains(event.target) && event.target !== notificationButton && !notificationButton.contains(event.target)) {
                        closeNotificationDropdown();
                    }
                }
            });

            if (announcementCloseBtn) {
                announcementCloseBtn.addEventListener('click', closeAnnouncement);
            }

            if (announcementOverlay) {
                announcementOverlay.addEventListener('click', (event) => {
                    if (event.target === announcementOverlay) {
                        closeAnnouncement();
                    }
                });
            }

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (announcementOverlay && announcementOverlay.classList.contains('visible')) {
                        closeAnnouncement();
                    } else if (notificationDropdown && notificationDropdown.classList.contains('visible')) {
                        closeNotificationDropdown();
                    }
                }
            });
        });

        // --- Dropdown user ---
        const userToggle = document.getElementById('user-dropdown-toggle');
        const userDropdown = document.getElementById('user-dropdown');
        if(userToggle && userDropdown){
            userToggle.addEventListener('click', function(e){
                e.stopPropagation();
                userDropdown.classList.toggle('show');
            });
            document.addEventListener('click', function(e){
                if(!userDropdown.contains(e.target) && e.target !== userToggle){
                    userDropdown.classList.remove('show');
                }
            });
        }
        document.addEventListener('DOMContentLoaded', function() {
            function renderUserDropdown() {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const userToggle = document.getElementById('user-dropdown-toggle');
                const userDropdown = document.getElementById('user-dropdown');
                if (!userToggle || !userDropdown) return;
                if (!isLoggedIn) {
                    userToggle.innerHTML = '<i class="fa-regular fa-circle-user user-icon" id="user-icon" style="color: #64748b; font-size: 1.6em;"></i>';
                    userDropdown.innerHTML = '<a href="#" class="user-dropdown-item" id="login-menu-item"><i class="fa-solid fa-right-to-bracket"></i> Đăng nhập</a>';
                } else {
                    userToggle.innerHTML = '<i class="fa-regular fa-circle-user user-icon" id="user-icon" style="color: #64748b; font-size: 1.6em;"></i>';
                    userDropdown.innerHTML = `
                        <div class="user-info">
                            <div class="user-avatar"><i class="fa-regular fa-circle-user"></i></div>
                            <div class="user-details"><h4>Phạm Hoàng Đình</h4><span class="user-role">Quản trị viên</span></div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="user-dropdown-item"><i class="fa-regular fa-user"></i> Thông tin cá nhân</a>
                        <a href="#" class="user-dropdown-item"><i class="fa-solid fa-gear"></i> Cài đặt tài khoản</a>
                        <a href="#" class="user-dropdown-item"><i class="fa-solid fa-bell"></i> Thông báo</a>
                        <a href="#" class="user-dropdown-item"><i class="fa-solid fa-shield-halved"></i> Bảo mật</a>
                        <div class="dropdown-divider"></div>
                        <a href="#" class="user-dropdown-item" id="logout-menu-item"><i class="fa-solid fa-right-from-bracket"></i> Đăng xuất</a>
                    `;
                }
                setTimeout(() => {
                    const loginItem = document.getElementById('login-menu-item');
                    if (loginItem) loginItem.onclick = function(e) { e.preventDefault(); window.location.href = 'login.html'; };
                    const logoutItem = document.getElementById('logout-menu-item');
                    if (logoutItem) logoutItem.onclick = function(e) { e.preventDefault(); localStorage.removeItem('isLoggedIn'); window.location.reload(); };
                }, 100);
            }
            renderUserDropdown();
            window.addEventListener('storage', renderUserDropdown);
        });

        // --- Render thông tin đơn hàng động từ localStorage ---
        document.addEventListener('DOMContentLoaded', function() {
            const data = JSON.parse(localStorage.getItem('currentOrderDetail') || '{}');
            const infoSection = document.getElementById('order-info-dynamic');
            const creatorInfo = document.getElementById('order-creator-info');
            if (!data || Object.keys(data).length === 0) {
                infoSection.innerHTML = '<div style="color:red;padding:12px 0;">Không có dữ liệu đơn hàng!</div>';
                creatorInfo.textContent = 'Người tạo: ...';
                return;
            }
            // Tính tổng cân nặng và số kiện
            let totalWeight = '';
            let soKien = '';
            if (Array.isArray(data.dimensions) && data.dimensions.length > 0) {
                totalWeight = data.dimensions.reduce((sum, d) => sum + (parseFloat(d.weight)||0), 0).toFixed(1) + ' Kg';
                soKien = data.dimensions.length;
            }
            // Số điện thoại: chỉ lấy 1 số người gửi
            let phones = data.sender_phone || '';
            // Hàng dễ vỡ
            let fragile = (data.is_fragile == '1' || data.is_fragile === true || data.is_fragile === 'true') ? 'Yes' : 'No';
            // Render HTML
            const html = `
                <div class="info-pair"> <span class="info-label">Tên Công ty:</span> <span class="info-value">${data.sender_company || ''}</span> </div>
                <div class="info-pair"> <span class="info-label">Tên người gửi:</span> <span class="info-value">${data.sender_name || ''}</span> </div>
                <div class="info-pair"> <span class="info-label">Số điện thoại:</span> <span class="info-value">${phones}</span> </div>
                <div class="info-pair"> <span class="info-label">Cân nặng:</span> <span class="info-value">${totalWeight}</span> </div>
                <div class="info-pair"> <span class="info-label">Số lượng kiện:</span> <span class="info-value">${soKien}</span> </div>
                <div class="info-pair"> <span class="info-label">Tên hàng hóa:</span> <span class="info-value">${data.product_name || ''}</span> </div>
                <div class="info-pair-row">
                    <div class="info-sub-pair"> <span class="info-label">Chi nhánh:</span> <span class="info-value">${data.branch || ''}</span> </div>
                    <div class="info-sub-pair"> <span class="info-label">Hình thức gửi:</span> <span class="info-value">${data.pickup_method || ''}</span> </div>
                </div>
                <div class="info-pair"> <span class="info-label">Hàng dễ vỡ:</span> <span class="info-value">${fragile}</span> </div>
                <div class="info-pair"> <span class="info-label">Dịch vụ:</span> <span class="info-value">${data.service_type || ''}</span> </div>
                <div class="info-pair"> <span class="info-label">Đại lý:</span> <span class="info-value">${data.agent || ''}</span> </div>
                <div class="info-pair"> <span class="info-label">Địa chỉ:</span> <span class="info-value">${data.sender_address || ''}</span> </div>
            `;
            infoSection.innerHTML = html;
            creatorInfo.textContent = 'Người tạo: ' + (data.creator || 'Phạm Hoàng Đình - S1');
        });

        // --- Lưu toàn bộ dữ liệu form (bao gồm ảnh) vào localStorage khi submit ---
        document.getElementById('pickup-order-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const data = {
                pickup_vehicle: document.getElementById('pickup_vehicle').value,
                pickup_time: document.getElementById('pickup_time').value,
                pickup_address: document.getElementById('pickup_address').value,
                pickup_notes: document.getElementById('pickup_notes').value,
                pickup_status: document.getElementById('pickup_status').value,
                pickup_cs: document.getElementById('pickup_cs').value,
                received_time: document.getElementById('received_time').value,
                export_time: document.getElementById('export_time').value,
                status_notes: document.getElementById('status_notes').value,
                images: []
            };
            console.log('Dữ liệu thu thập từ form:', data);
            const files = document.getElementById('pickup_images').files;
            if (files.length > 0) {
                let loaded = 0;
                for (let i = 0; i < files.length; i++) {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        data.images.push(evt.target.result);
                        loaded++;
                        if (loaded === files.length) {
                            localStorage.setItem('pickupOrder', JSON.stringify(data));
                            // alert('Đã lưu thông tin pickup (bao gồm ảnh) vào localStorage!');
                            window.location.href = 'package_manager.html';
                        }
                    };
                    reader.readAsDataURL(files[i]);
                }
            } else {
                localStorage.setItem('pickupOrder', JSON.stringify(data));
                // alert('Đã lưu thông tin pickup (không có ảnh) vào localStorage!');
                window.location.href = 'package_manager.html';
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo datetime picker cho pickup_time
            const pickupTimeInput = document.getElementById('pickup_time');
            if (pickupTimeInput) {
                const picker = new tempusDominus.TempusDominus(pickupTimeInput, {
                    display: {
                        components: {
                            decades: true,
                            year: true,
                            month: true,
                            date: true,
                            hours: true,
                            minutes: true,
                            seconds: false,
                            useTwentyfourHour: true
                        },
                        icons: {
                            type: 'icons',
                            time: 'fa fa-clock',
                            date: 'fa fa-calendar',
                            up: 'fa fa-arrow-up',
                            down: 'fa fa-arrow-down',
                            previous: 'fa fa-chevron-left',
                            next: 'fa fa-chevron-right',
                            today: 'fa fa-calendar-check',
                            clear: 'fa fa-trash',
                            close: 'fa fa-times'
                        }
                    },
                    localization: {
                        format: 'dd/MM/yyyy HH:mm'
                    }
                });
                picker.subscribe('change.datetimepicker', (e) => {
                    if (e.detail.date) {
                        const selectedDate = e.detail.date;
                        const year = selectedDate.getFullYear();
                        const month = (selectedDate.getMonth() + 1).toString().padStart(2, '0');
                        const day = selectedDate.getDate().toString().padStart(2, '0');
                        const hours = selectedDate.getHours().toString().padStart(2, '0');
                        const minutes = selectedDate.getMinutes().toString().padStart(2, '0');
                        const formattedDate = `${day}/${month}/${year} ${hours}:${minutes}`;

                        pickupTimeInput.value = formattedDate;
                        console.log('Pickup Time selected:', formattedDate);
                    } else {
                        pickupTimeInput.value = '';
                        console.log('Pickup Time cleared');
                    }
                });
            }

            // Khởi tạo datetime picker cho received_time
            const receivedTimeInput = document.getElementById('received_time');
            if (receivedTimeInput) {
                const picker = new tempusDominus.TempusDominus(receivedTimeInput, {
                    display: {
                        components: {
                            decades: true,
                            year: true,
                            month: true,
                            date: true,
                            hours: true,
                            minutes: true,
                            seconds: false,
                            useTwentyfourHour: true
                        },
                        icons: {
                            type: 'icons',
                            time: 'fa fa-clock',
                            date: 'fa fa-calendar',
                            up: 'fa fa-arrow-up',
                            down: 'fa fa-arrow-down',
                            previous: 'fa fa-chevron-left',
                            next: 'fa fa-chevron-right',
                            today: 'fa fa-calendar-check',
                            clear: 'fa fa-trash',
                            close: 'fa fa-times'
                        }
                    },
                    localization: {
                        format: 'dd/MM/yyyy HH:mm'
                    }
                });
                picker.subscribe('change.datetimepicker', (e) => {
                    if (e.detail.date) {
                        const selectedDate = e.detail.date;
                        const year = selectedDate.getFullYear();
                        const month = (selectedDate.getMonth() + 1).toString().padStart(2, '0');
                        const day = selectedDate.getDate().toString().padStart(2, '0');
                        const hours = selectedDate.getHours().toString().padStart(2, '0');
                        const minutes = selectedDate.getMinutes().toString().padStart(2, '0');
                        const formattedDate = `${day}/${month}/${year} ${hours}:${minutes}`;

                        receivedTimeInput.value = formattedDate;
                        console.log('Received Time selected:', formattedDate);
                    } else {
                        receivedTimeInput.value = '';
                        console.log('Received Time cleared');
                    }
                });
            }

            // Khởi tạo datetime picker cho export_time
            const exportTimeInput = document.getElementById('export_time');
            if (exportTimeInput) {
                const picker = new tempusDominus.TempusDominus(exportTimeInput, {
                    display: {
                        components: {
                            decades: true,
                            year: true,
                            month: true,
                            date: true,
                            hours: true,
                            minutes: true,
                            seconds: false,
                            useTwentyfourHour: true
                        },
                        icons: {
                            type: 'icons',
                            time: 'fa fa-clock',
                            date: 'fa fa-calendar',
                            up: 'fa fa-arrow-up',
                            down: 'fa fa-arrow-down',
                            previous: 'fa fa-chevron-left',
                            next: 'fa fa-chevron-right',
                            today: 'fa fa-calendar-check',
                            clear: 'fa fa-trash',
                            close: 'fa fa-times'
                        }
                    },
                    localization: {
                        format: 'dd/MM/yyyy HH:mm'
                    }
                });
                picker.subscribe('change.datetimepicker', (e) => {
                    if (e.detail.date) {
                        const selectedDate = e.detail.date;
                        const year = selectedDate.getFullYear();
                        const month = (selectedDate.getMonth() + 1).toString().padStart(2, '0');
                        const day = selectedDate.getDate().toString().padStart(2, '0');
                        const hours = selectedDate.getHours().toString().padStart(2, '0');
                        const minutes = selectedDate.getMinutes().toString().padStart(2, '0');
                        const formattedDate = `${day}/${month}/${year} ${hours}:${minutes}`;

                        exportTimeInput.value = formattedDate;
                        console.log('Export Time selected:', formattedDate);
                    } else {
                        exportTimeInput.value = '';
                        console.log('Export Time cleared');
                    }
                });
            }
        });
    </script>
</body>
</html>