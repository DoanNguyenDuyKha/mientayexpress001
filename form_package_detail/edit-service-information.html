<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        .edit-service-info-form {
            --form-primary-color: #FFD600;
            --form-primary-hover: #FFB300;
            --form-secondary-color: #181818;
            --form-success-color: #FFD600;
            --form-danger-color: #EF4444;
            --form-light-gray: #f8f9fa;
            --form-input-bg: #fff;
            --form-input-readonly-bg: #e9ecef;
            --form-border-color: rgba(255, 214, 0, 0.2);
            --form-border-color-light: #eee;
            --form-text-color: #181818;
            --form-text-muted: #64748b;
            --form-border-radius: 9px;
            --form-spacing-unit: 10px;
            --form-control-padding-y: 10px;
            --form-control-padding-x: 16px;
            --form-font-size-base: 12px;
            --form-font-size-sm: 10px;
            --form-font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --form-shadow-lg: 0 10px 15px rgba(0,0,0,0.10);
            --form-transition: all 0.3s ease;

            box-sizing: border-box;
            font-family: var(--form-font-family);
            font-size: var(--form-font-size-base);
            color: var(--form-text-color);
            background-color: var(--form-input-bg);
            display: flex; flex-direction: column;
            line-height: 1.5; margin: 0; padding: 0; border: none; width: 100%;
             max-width: 100%;
             overflow: hidden;
             border-radius: var(--form-border-radius);
        }

        .edit-service-info-form *,
        .edit-service-info-form *::before,
        .edit-service-info-form *::after {
            box-sizing: border-box; margin: 0; padding: 0; border-width: 0;
            border-style: solid; border-color: transparent;
            background: transparent; font: inherit; color: inherit;
            line-height: inherit; vertical-align: baseline;
        }
        .edit-service-info-form div, .edit-service-info-form header, .edit-service-info-form form,
        .edit-service-info-form label, .edit-service-info-form h2 { display: block; }
        .edit-service-info-form span, .edit-service-info-form i { display: inline-block; vertical-align: middle; }
        .edit-service-info-form button { display: inline-flex; align-items: center; justify-content: center; }
        .edit-service-info-form input[type="text"], .edit-service-info-form input[type="number"],
        .edit-service-info-form select { display: block; width: 100%; }
        .edit-service-info-form label { display: block; margin-bottom: calc(var(--form-spacing-unit) * 0.5); }

        .edit-service-info-form .form-header {
            background: linear-gradient(90deg, #FFD700 0%, #FFF8DC 100%);
            color: var(--form-primary-color) !important;
            padding: calc(var(--form-spacing-unit) * 2) calc(var(--form-spacing-unit) * 2.5) !important;
            flex-shrink: 0; border-bottom: 1.5px solid var(--form-primary-color) !important;
             border-top-left-radius: var(--form-border-radius);
             border-top-right-radius: var(--form-border-radius);
             display: flex; align-items: center;
        }
        .edit-service-info-form .form-header h2 {
            font-size: 1.18rem !important; font-weight: 700 !important; color: var(--form-secondary-color); margin:0;
            display: flex; align-items: center; gap: 0.75rem;
        }
        .edit-service-info-form .form-header h2::before {
            content: '\f013';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 1.4em;
            color: var(--form-secondary-color);
        }

        .edit-service-info-form #formServiceInfoModal { display: contents; }

        .edit-service-info-form .form-body {
            padding: calc(var(--form-spacing-unit) * 2.5) !important;
            display: flex; flex-direction: column;
            gap: calc(var(--form-spacing-unit) * 2.5) !important;
            background-color: var(--form-input-bg) !important;
            flex-grow: 1; overflow-y: auto;
        }

        .edit-service-info-form .modal-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: calc(var(--form-spacing-unit) * 2.5); align-items: start; }
        .edit-service-info-form .form-note-row { margin-top: calc(var(--form-spacing-unit) * -1.5); }

        .edit-service-info-form .form-group { display: flex; flex-direction: column; gap: calc(var(--form-spacing-unit) * 0.7); }

        .edit-service-info-form .form-group .main-label { font-weight: 600; color: var(--form-secondary-color); font-size: var(--form-font-size-base); }

        .edit-service-info-form .input-options-group { display: flex; flex-wrap: wrap; gap: calc(var(--form-spacing-unit) * 1) calc(var(--form-spacing-unit) * 2.5) !important; align-items: center; }
        .edit-service-info-form .checkbox-group { gap: calc(var(--form-spacing-unit) * 1.2) calc(var(--form-spacing-unit) * 3) !important; }

        .edit-service-info-form .radio-option,
        .edit-service-info-form .checkbox-option { display: inline-flex; align-items: center; gap: calc(var(--form-spacing-unit) * 0.9) !important; cursor: pointer; font-size: var(--form-font-size-base); color: var(--form-text-color); line-height: 1.4; vertical-align: middle; margin-bottom: 0; }

        .edit-service-info-form input[type="radio"],
        .edit-service-info-form input[type="checkbox"] {
             appearance: none; -webkit-appearance: none; margin: 0;
             width: 18px; height: 18px; border: 1.5px solid var(--form-primary-color);
             position: relative; cursor: pointer; transition: background-color 0.15s, border-color 0.15s;
             flex-shrink: 0; vertical-align: middle; display: inline-block;
             background-color: #fff;
        }
        .edit-service-info-form input[type="radio"] { border-radius: 50%; }
        .edit-service-info-form input[type="checkbox"] { border-radius: 5px; }

        .edit-service-info-form input[type="radio"]::before,
        .edit-service-info-form input[type="checkbox"]::before {
            content: ''; display: block; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            transition: transform 0.15s ease-in-out;
        }
        .edit-service-info-form input[type="radio"]::before { width: 10px; height: 10px; border-radius: 50%; background-color: #FFD600; }
        .edit-service-info-form input[type="checkbox"]::before {
             width: 12px; height: 10px; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23ffffff' d='M6.564.75l-3.59 3.6-1.5-1.5-.964.964 2.464 2.464 4.55-4.55z'/%3e%3csvg%3e");
             background-repeat: no-repeat; background-position: center; background-size: contain;
             opacity: 0; transition: transform 0.15s ease-in-out, opacity 0.15s ease-in-out;
        }

        .edit-service-info-form input[type="radio"]:checked { border-color: #FFD600; background-color: #fff; }
        .edit-service-info-form input[type="radio"]:checked::before { transform: translate(-50%, -50%) scale(1); }
        .edit-service-info-form input[type="checkbox"]:checked { border-color: #FFD600; background-color: #FFD600; }
        .edit-service-info-form input[type="checkbox"]:checked::before { transform: translate(-50%, -50%) scale(1); opacity: 1; }

        .edit-service-info-form .form-select {
            width: 100%; padding: var(--form-control-padding-y) calc(var(--form-control-padding-x) * 2.5) var(--form-control-padding-y) var(--form-control-padding-x);
            border: 1.5px solid var(--form-border-color); border-radius: var(--form-border-radius);
            background-color: #fff; font-size: var(--form-font-size-base);
            font-family: var(--form-font-family); color: var(--form-text-color); line-height: 1.5;
            transition: var(--form-transition);
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='%23FFD600' stroke='%23FFD600' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3csvg%3e");
            background-repeat: no-repeat; background-position: right var(--form-control-padding-x) center;
            background-size: 16px 12px; min-height: calc(1.5em + var(--form-control-padding-y) * 2 + 2px);
            display: block; margin: 0;
        }
        .edit-service-info-form .form-select:focus {
            border-color: #FFD600;
            outline: 0; box-shadow: 0 0 0 3px rgba(255, 214, 0, 0.15);
        }

        .edit-service-info-form .form-note { font-size: var(--form-font-size-sm); color: var(--form-danger-color); display: block; line-height: 1.4; padding-left: 2px; }
        .edit-service-info-form .form-note .note-icon { display: none; }

        .edit-service-info-form .form-actions {
            padding: calc(var(--form-spacing-unit) * 2) calc(var(--form-spacing-unit) * 2.5);
            background: white;
            border-top: 1.5px solid var(--form-primary-color);
            display: flex; justify-content: flex-end; gap: var(--form-spacing-unit); flex-shrink: 0;
             border-bottom-left-radius: var(--form-border-radius);
             border-bottom-right-radius: var(--form-border-radius);
        }

        .edit-service-info-form .form-btn {
            gap: calc(var(--form-spacing-unit) * 0.8); padding: calc(var(--form-control-padding-y) + 2px) calc(var(--form-control-padding-x) * 1.5);
            font-size: var(--form-font-size-base); font-weight: 600; border-radius: var(--form-border-radius);
            border: 1.5px solid transparent; cursor: pointer; transition: var(--form-transition);
            line-height: 1.4; white-space: nowrap; min-width: 100px;
        }
        .edit-service-info-form .form-btn i { font-size: 1em; margin-right: 4px; font-family: "Font Awesome 6 Free"; font-weight: 900; line-height: 1; }
        .edit-service-info-form .form-btn-cancel {
            background-color: transparent;
            color: var(--form-primary-color);
            border-color: var(--form-primary-color);
        }
        .edit-service-info-form .form-btn-cancel:hover {
            background-color: var(--form-primary-color);
            color: var(--form-secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 214, 0, 0.2);
        }
        .edit-service-info-form .form-btn-confirm {
            background: linear-gradient(90deg, var(--form-primary-color) 0%, var(--form-primary-hover) 100%);
            color: var(--form-secondary-color);
            border: none;
            box-shadow: 0 2px 8px rgba(255, 214, 0, 0.15);
        }
        .edit-service-info-form .form-btn-confirm:hover {
            background: linear-gradient(90deg, var(--form-primary-hover) 0%, var(--form-primary-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 214, 0, 0.2);
        }
        .edit-service-info-form .form-btn:focus-visible {
            outline: 1.5px solid var(--form-primary-color);
            outline-offset: 1px;
            box-shadow: none;
        }
        .edit-service-info-form .form-btn:active {
            transform: scale(0.98);
        }

        @media (max-width: 600px) {
            .edit-service-info-form .modal-form-row { grid-template-columns: 1fr; gap: calc(var(--form-spacing-unit) * 2); }
            .edit-service-info-form .form-note-row { margin-top: 0; }
            .edit-service-info-form .form-body { padding: calc(var(--form-spacing-unit) * 2); gap: calc(var(--form-spacing-unit) * 2); }
            .edit-service-info-form .form-header,
            .edit-service-info-form .form-actions { padding: calc(var(--form-spacing-unit) * 1.5) calc(var(--form-spacing-unit) * 2); }
            .edit-service-info-form .form-actions { justify-content: space-between; gap: calc(var(--form-spacing-unit)* 1.5); }
            .edit-service-info-form .form-btn { flex-grow: 1; max-width: 48%; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="form-container edit-service-info-form">
        <div class="form-header">
            <h2>Chỉnh sửa thông tin Dịch Vụ</h2>
        </div>
        <form id="formServiceInfoModal">
            <div class="form-body">
                <div class="form-group">
                    <label class="main-label">Lý do gửi hàng:</label>
                    <div class="input-options-group">
                        <label class="radio-option"><input type="radio" name="reason_for_sending" value="gift" checked> Gift (no commercial value)</label>
                        <label class="radio-option"><input type="radio" name="reason_for_sending" value="sample"> Sample</label>
                    </div>
                </div>
                 <div class="form-group">
                    <label class="main-label">Loại bưu gửi:</label>
                    <div class="input-options-group">
                        <label class="radio-option"><input type="radio" name="parcel_type" value="goods" checked> Hàng hóa</label>
                        <label class="radio-option"><input type="radio" name="parcel_type" value="docs"> Tài liệu</label>
                    </div>
                </div>
                <div class="modal-form-row">
                     <div class="form-group">
                         <label for="serviceSelectModal" class="main-label">Chọn dịch vụ:</label>
                         <select id="serviceSelectModal" name="service_code" class="form-select">
                            <option value="MTE_DHL_SIN" selected>MTE DHL SIN</option>
                            <option value="MTE_UPS_US">MTE UPS US</option>
                            <option value="VNPOST_EMS">VNPOST EMS</option>
                         </select>
                     </div>
                     <div class="form-group">
                          <label for="branchSelectModal" class="main-label">Chi nhánh:</label>
                          <select id="branchSelectModal" name="branch_code" class="form-select">
                            <option value="TPHCM_TANPHU" selected>Tân Phú - HCM</option>
                            <option value="HN_CAUGIAY">Cầu Giấy - HN</option>
                          </select>
                     </div>
                </div>
                 <div class="form-note-row">
                      <div class="form-note">
                           <span>Lưu ý*: Một số dịch vụ chỉ nhận từ 20kg trở lên.</span>
                      </div>
                 </div>
                <div class="form-group">
                    <label class="main-label">Dịch vụ cộng thêm:</label>
                    <div class="input-options-group checkbox-group">
                        <label class="checkbox-option"><input type="checkbox" name="add_service_signature" value="signature"> Chữ ký</label>
                        <label class="checkbox-option"><input type="checkbox" name="add_service_insurance" value="insurance"> Bảo hiểm hàng hóa</label>
                        <label class="checkbox-option"><input type="checkbox" name="add_service_fumigation" value="fumigation"> FUMIGATION</label>
                        <label class="checkbox-option"><input type="checkbox" name="add_service_wood_crate" value="wood_crate"> Đóng kiện gỗ</label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="main-label">Hình thức gửi hàng:</label>
                    <div class="input-options-group">
                        <label class="radio-option"><input type="radio" name="sending_method" value="pickup" checked> Thu gom tận nơi</label>
                        <label class="radio-option"><input type="radio" name="sending_method" value="dropoff"> Lấy hàng tại bưu cục</label>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="form-btn form-btn-cancel modal-cancel-button"> <i class="fa-solid fa-xmark"></i> Hủy</button>
                <button type="button" class="form-btn form-btn-confirm modal-confirm-button"> <i class="fa-solid fa-check"></i> Xác nhận</button>
            </div>
        </form>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Load dữ liệu từ localStorage khi mở modal
            const orderData = JSON.parse(localStorage.getItem('currentOrderDetail') || '{}');
            
            // Điền dữ liệu vào form
            const serviceSelect = document.getElementById('serviceSelectModal');
            const branchSelect = document.getElementById('branchSelectModal');
            const reasonRadios = document.getElementsByName('reason_for_sending');
            const parcelTypeRadios = document.getElementsByName('parcel_type');
            const addServiceCheckboxes = document.querySelectorAll('input[name^="add_service_"]');

            // Điền thông tin dịch vụ
            if (serviceSelect && orderData.service_code) {
                serviceSelect.value = orderData.service_code;
            }

            // Điền thông tin chi nhánh
            if (branchSelect && orderData.branch_code) {
                branchSelect.value = orderData.branch_code;
            }

            // Điền lý do gửi hàng
            if (reasonRadios.length > 0 && orderData.reason_for_sending) {
                reasonRadios.forEach(radio => {
                    if (radio.value === orderData.reason_for_sending) {
                        radio.checked = true;
                    }
                });
            }

            // Điền loại bưu gửi
            if (parcelTypeRadios.length > 0 && orderData.parcel_type) {
                parcelTypeRadios.forEach(radio => {
                    if (radio.value === orderData.parcel_type) {
                        radio.checked = true;
                    }
                });
            }

            // Điền dịch vụ cộng thêm
            if (addServiceCheckboxes.length > 0 && orderData.add_service) {
                const addServices = Array.isArray(orderData.add_service) ? orderData.add_service : [orderData.add_service];
                addServiceCheckboxes.forEach(checkbox => {
                    const serviceName = checkbox.name.replace('add_service_', '');
                    let displayName = '';
                    if (serviceName === 'signature') displayName = 'Chữ ký';
                    else if (serviceName === 'insurance') displayName = 'Bảo hiểm hàng hóa';
                    else if (serviceName === 'fumigation') displayName = 'FUMIGATION';
                    else if (serviceName === 'wood_crate') displayName = 'Đóng kiện gỗ';
                    else displayName = serviceName.toUpperCase();
                    
                    checkbox.checked = addServices.includes(displayName);
                });
            }

            // Xử lý sự kiện khi nhấn nút Xác nhận
            const confirmButton = document.querySelector('.modal-confirm-button');
            if (confirmButton) {
                confirmButton.addEventListener('click', function() {
                    // Lấy dữ liệu từ form
                    const formData = new FormData(document.getElementById('formServiceInfoModal'));
                    const serviceData = {
                        service_code: formData.get('service_code'),
                        branch_code: formData.get('branch_code'),
                        reason_for_sending: formData.get('reason_for_sending'),
                        parcel_type: formData.get('parcel_type'),
                        add_service: []
                    };

                    // Lấy danh sách dịch vụ cộng thêm
                    addServiceCheckboxes.forEach(checkbox => {
                        if (checkbox.checked) {
                            const serviceName = checkbox.name.replace('add_service_', '');
                            let displayName = '';
                            if (serviceName === 'signature') displayName = 'Chữ ký';
                            else if (serviceName === 'insurance') displayName = 'Bảo hiểm hàng hóa';
                            else if (serviceName === 'fumigation') displayName = 'FUMIGATION';
                            else if (serviceName === 'wood_crate') displayName = 'Đóng kiện gỗ';
                            else displayName = serviceName.toUpperCase();
                            serviceData.add_service.push(displayName);
                        }
                    });

                    // Validate dữ liệu
                    if (!serviceData.service_code) {
                        alert('Vui lòng chọn dịch vụ');
                        serviceSelect.focus();
                        return;
                    }
                    if (!serviceData.branch_code) {
                        alert('Vui lòng chọn chi nhánh');
                        branchSelect.focus();
                        return;
                    }
                    if (!serviceData.reason_for_sending) {
                        alert('Vui lòng chọn lý do gửi hàng');
                        return;
                    }
                    if (!serviceData.parcel_type) {
                        alert('Vui lòng chọn loại bưu gửi');
                        return;
                    }

                    // Lấy dữ liệu hiện tại từ localStorage
                    const currentOrderData = JSON.parse(localStorage.getItem('currentOrderDetail') || '{}');
                    
                    // Cập nhật dữ liệu dịch vụ
                    const updatedOrderData = {
                        ...currentOrderData,
                        service_code: serviceData.service_code,
                        service_type: serviceSelect.options[serviceSelect.selectedIndex].text,
                        branch_code: serviceData.branch_code,
                        reason_for_sending: serviceData.reason_for_sending,
                        parcel_type: serviceData.parcel_type,
                        add_service: serviceData.add_service
                    };

                    // Lưu vào localStorage
                    localStorage.setItem('currentOrderDetail', JSON.stringify(updatedOrderData));

                    // Cập nhật hiển thị trên trang chính
                    if (window.parent) {
                        const serviceNameDisplay = window.parent.document.getElementById('serviceNameValue');
                        const additionalServicesDisplay = window.parent.document.getElementById('additionalServicesValue');
                        
                        if (serviceNameDisplay) {
                            serviceNameDisplay.textContent = serviceSelect.options[serviceSelect.selectedIndex].text;
                        }
                        if (additionalServicesDisplay) {
                            additionalServicesDisplay.textContent = serviceData.add_service.join(' / ');
                        }
                    }

                    // Thông báo thành công
                    alert('Đã cập nhật thông tin dịch vụ thành công!');

                    // Đóng modal
                    if (window.parent && typeof window.parent.closeEditModal === 'function') {
                        window.parent.closeEditModal();
                    }
                });
            }

            // Xử lý sự kiện khi nhấn nút Hủy
            const cancelButton = document.querySelector('.modal-cancel-button');
            if (cancelButton) {
                cancelButton.addEventListener('click', function() {
                    if (window.parent && typeof window.parent.closeEditModal === 'function') {
                        window.parent.closeEditModal();
                    }
                });
            }

            // Xử lý phím Enter và Escape
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    confirmButton.click();
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    cancelButton.click();
                }
            });
        });
    </script>
</body>
</html>